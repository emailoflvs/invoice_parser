# Invoice Parser

Универсальный парсер украинских накладных для PDF и изображений с использованием Google Vision API и OpenAI GPT-4o.

## Возможности

✅ **Многостраничные PDF** - обрабатывает документы с сотнями товаров
✅ **Изображения JPG/PNG** - поддержка сканов и фотографий
✅ **Улучшение качества** - 4x увеличение, контраст, резкость для лучшего OCR
✅ **Нормализация OCR** - автоматическое исправление разорванных артикулов
✅ **Excel экспорт** - 14 колонок с реквизитами и товарами

## Установка

```bash
# Зависимости
pip install anthropic openai python-dotenv xlwt xlrd xlutils pdf2image pillow requests

# API ключи в .env
GOOGLE_VISION_API_KEY=your_key_here
OPENAI_API_KEY=your_key_here
XLS_PATH='табліца накладних.xls'
```

## Использование

```bash
# Один документ
python3 invoice_parser.py invoices/invoice.pdf

# Несколько документов
python3 invoice_parser.py invoices/*.pdf invoices/*.jpg

# Свой файл Excel
python3 invoice_parser.py invoices/*.pdf custom_output.xls
```

## Архитектура

```
PDF/JPG → Улучшение 4x → Google Vision OCR → OpenAI (header + items) → Excel
```

**Этапы обработки:**

1. **Улучшение изображения** - 4x разрешение, контраст +100%, яркость +40%, резкость x5
2. **Google Vision API** - DOCUMENT_TEXT_DETECTION для извлечения текста
3. **OpenAI GPT-4o (2 запроса)**:
   - `prompt-header.txt` - реквизиты поставщика
   - `prompt-items_multiple_vs_openai.txt` - товары с нормализацией OCR
4. **Excel export** - 14 колонок с полными данными

## Формат Excel (14 колонок)

| Колонка | Описание |
|---------|----------|
| 1. постачальник | Название поставщика |
| 2. код ЄДРПОУ | EDRPOU код |
| 3. телефон | Телефон |
| 4. адреса | Адрес |
| 5. дата накладної | Дата документа |
| 6. номер накладної | Номер документа |
| 7. УКТ ЗЕД | Код товара |
| 8. наименование товара | Название |
| 9. обозначение товара | Артикул |
| 10. ціна за шт без пдв | Цена без НДС |
| 11. кіл-сть штук | Количество |
| 12. сума без пдв | Сумма без НДС |
| 13. ціна за одиницю з ПДВ | Цена с НДС |
| 14. сума з ПДВ | Сумма с НДС |

## Протестировано

| Документ | Страниц | Товаров | Результат |
|----------|---------|---------|-----------|
| dnipromash.pdf | 2 | 74 | ✅ Артикулы 100% |
| invoiceCamozzi.pdf | 2 | 66 | ✅ Все корректно |
| lakover.jpg | 1 | 1 | ✅ Артикул правильно |

**Особенности парсинга:**
- Артикулы типа `521.318.01.04.06.001` распознаются корректно
- Исправление OCR ошибок: `"1\n18.A\nW1013"` → `"1HW1013.05.05.8A"`
- Склейка многострочных ячеек в артикулы

## Известные проблемы

⚠️ На сложных документах возможны небольшие ошибки в парсинге цен (~3-5% пустых значений)

## Структура проекта

```
invoice_parser/
├── invoice_parser.py               # Основной скрипт
├── prompt-header.txt               # Промпт для реквизитов
├── prompt-items_multiple_vs_openai.txt  # Промпт для товаров
├── .env                            # API ключи
├── invoices/                       # Входные документы
└── don't need/                     # Архив тестов и альтернатив
```

## История разработки

Создан путём тестирования 3 подходов:

1. **Claude Sonnet 4** (`invoice_parser_enhanced_multiply_claude.py`) - нативный PDF, постобработка
2. **Google Vision с координатами** (`invoice_parser_multiple_gv_openai.py`) - группировка слов в ячейки
3. **Google Vision + улучшение 4x** (`invoice_parser.py`) - ✅ **лучший результат**

## Лицензия

MIT

## Автор

Created with Claude Code
