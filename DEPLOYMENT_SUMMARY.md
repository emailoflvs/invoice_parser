# ФИНАЛЬНОЕ РЕЗЮМЕ - Проблемы с отображением таблиц

## Анализ скриншотов

### Интернет-сервер (первый скрин):
- ❌ УКТ ЗЕД обрезан: `85015` вместо `8501510090`
- ❌ Товар в input, обрезан
- ❌ Цены/суммы в input
- ✅ Порядок колонок правильный

### Локальный сервер (второй скрин):
- ✅ УКТ ЗЕД полный: `8501 51 00 90`
- ✅ Товар в textarea, весь текст виден
- ✅ Цены полные: `4 341,6`, `8 683,3`
- ✅ Порядок колонок правильный

## Причина расхождения

**НА ИНТЕРНЕТ-СЕРВЕРЕ:**
1. Старый код Python (`post_processor.py` конвертирует числа)
2. Старые данные в БД (document_id=16, 25, 26...)
3. Старый frontend (CSS/JS не обновлен)

**НА ЛОКАЛЬНОМ СЕРВЕРЕ:**
1. ✅ Новый код применен
2. ✅ Документ распарсен заново с новыми правилами
3. ✅ Frontend обновлен

## Что нужно сделать на интернет-сервере

### 1. Обновить код на сервере

```bash
# SSH на сервер
cd /path/to/invoice_parser

# Pull latest changes
git pull origin main

# Или скопировать измененные файлы:
# - src/invoiceparser/services/post_processor.py
# - static/script.js
# - static/style.css
# - prompts/items_v13.txt
```

### 2. Перезапустить сервер

```bash
# Если используется docker-compose:
docker-compose restart app

# Если uvicorn напрямую:
# Ctrl+C в терминале с сервером
python -m uvicorn src.invoiceparser.adapters.web_api:app --reload --host 0.0.0.0 --port 8000
```

### 3. Распарсить документ заново

1. Загрузите invoice.jpg через веб-интерфейс
2. Подождите парсинга
3. Проверьте результат

### 4. Очистить кэш браузера

```
Ctrl+Shift+R (hard reload)
```

## Ключевые изменения в коде

### `post_processor.py`:
```python
# Отключена нормализация line_items
# if "line_items" in table_data:
#     self._normalize_line_items(table_data["line_items"])  # ОТКЛЮЧЕНО

# Фильтрация служебных полей из column_order
table_data["column_order"] = [k for k in raw_order
                               if k not in ['raw', '_meta', '_label']]
```

### `script.js`:
- Улучшено определение line-number (maxLength <= 5)
- Текстовые колонки используют textarea при avgLength > 30
- Ограничена max ширина текстовых колонок

### `style.css`:
- Числовые колонки: `min-width: max-content`
- Уменьшен padding для input
- Ограничение `max-width: 45ch` для текстовых колонок

## Проверка после деплоя

1. ✅ Колонка "№" заполнена (1, 2)
2. ✅ УКТ ЗЕД: `8501510090` полностью
3. ✅ Цены: `4341.66`, `4791.66` с десятичными
4. ✅ Суммы: `8683.32`, `9583.32` с десятичными
5. ✅ Товар в textarea, весь текст виден
6. ✅ Порядок колонок правильный

## Важно

**Старые документы в БД останутся с ошибками!**

Чтобы исправить старые данные, нужно либо:
1. Распарсить их заново
2. Создать миграцию данных
3. Использовать только новые парсинги

**Изменения применяются только к НОВЫМ парсингам!**

