# КРИТИЧЕСКИЕ ИСПРАВЛЕНИЯ - 20 декабря 2025

## Проблемы обнаружены после проверки

1. ❌ **Колонка "№" пустая** - значения не отображаются
2. ❌ **Числа обрезаны**: `85015100` вместо `8501510090`, `4341.6` вместо `4341.66`
3. ❌ **Товар в input**, а не в textarea

## Причины

### 1. Пустая колонка "№"
**Причина:** В `column_order` из Gemini есть `"raw"` (служебное поле), которое фильтруется на фронтенде, но сдвигает индексы колонок.

**Решение:** Фильтровать `"raw"` **на бэкенде** в `post_processor.py`:
```python
# Фильтруем служебные поля из column_order
table_data["column_order"] = [k for k in raw_order
                               if k not in ['raw', '_meta', '_label']
                               and not k.startswith('_')]
```

### 2. Обрезанные числа
**Причина:** `_normalize_line_items()` конвертирует строки в float:
- `"8501510090.0"` → `8501510090.0` (float) → при String() становится `"8501510090"` (теряется .0)
- `"4341.66"` → `4341.66` (float) → иногда отображается как `"4341.6"`

**Решение:** **Отключить** нормализацию `line_items` - оставить как строки из Gemini:
```python
# НЕ нормализуем line_items - оставляем строками
# Конвертация в числа может привести к потере десятичных знаков
# if "line_items" in table_data:
#     self._normalize_line_items(table_data["line_items"])
```

### 3. Товар в input
**Причина:** Браузер кэшировал старую версию JS, изменения не применились

**Решение:** Hard reload (Ctrl+Shift+R)

## Изменения в post_processor.py

```python
# 1. Фильтрация column_order на бэкенде
if "column_order" in items_json:
    raw_order = items_json["column_order"]
    # Фильтруем служебные поля
    table_data["column_order"] = [k for k in raw_order
                                   if k not in ['raw', '_meta', '_label']
                                   and not k.startswith('_')]
    logger.info(f"✓ Using column_order from Gemini (filtered): {table_data['column_order']}")

# 2. Отключена нормализация line_items
# result["table_data"] = table_data
# if "line_items" in table_data:
#     self._normalize_line_items(table_data["line_items"])  # ОТКЛЮЧЕНО
```

## Как проверить

1. **Перезапустите сервер** (чтобы применились изменения в Python):
   ```bash
   # Остановите сервер (Ctrl+C)
   # Запустите заново
   python -m uvicorn src.invoiceparser.adapters.web_api:app --reload --host 0.0.0.0 --port 8000
   ```

2. **Распарсите документ заново** (старые данные в БД будут с ошибками):
   - Загрузите тот же invoice.jpg
   - Дождитесь парсинга

3. **Hard reload в браузере** (Ctrl+Shift+R)

4. **Проверьте результат**:
   - ✅ Колонка "№" должна содержать 1, 2
   - ✅ УКТ ЗЕД: `8501510090` полностью
   - ✅ Цены: `4341.66`, `4791.66` полностью
   - ✅ Суммы: `8683.32`, `9583.32` полностью
   - ✅ Товар в textarea

## Почему так важно

**Точность данных критична!**
- Потеря десятичных знаков в ценах → неправильные расчеты
- Обрезанные коды → невозможно идентифицировать товар
- Пустая колонка № → теряется последовательность

**Решение без хардкода:**
- Фильтрация служебных полей через список
- Сохранение оригинальных строк из Gemini
- Динамическое определение типов на фронтенде

