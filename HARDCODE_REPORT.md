# üîç –û—Ç—á–µ—Ç –æ —Ö–∞—Ä–¥–∫–æ–¥–µ –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ

–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∂–µ—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π.

---

## ‚úÖ –ù–∞–π–¥–µ–Ω–Ω—ã–π —Ö–∞—Ä–¥–∫–æ–¥

### 1. **–•–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω—ã–π –ø—É—Ç—å `/app/src`** ‚ö†Ô∏è

**–§–∞–π–ª:** `src/invoiceparser/adapters/web_api.py:425`

```python
reload_dirs=["/app/src"],
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—É—Ç—å –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω –¥–ª—è Docker –æ–∫—Ä—É–∂–µ–Ω–∏—è. –ù–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```python
reload_dirs=[str(Path(__file__).parent.parent.parent.parent / "src")],
```

---

### 2. **–•–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ "Bearer "** ‚ö†Ô∏è

**–§–∞–π–ª:** `src/invoiceparser/adapters/web_api.py:392-393`

```python
if token.startswith("Bearer "):
    token = token[7:]
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–∞–≥–∏—á–µ—Å–∫–æ–µ —á–∏—Å–ª–æ `7` (–¥–ª–∏–Ω–∞ "Bearer "). –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç, —Å–ª–æ–º–∞–µ—Ç—Å—è.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É:
```python
BEARER_PREFIX = "Bearer "
if token.startswith(BEARER_PREFIX):
    token = token[len(BEARER_PREFIX):]
```

---

### 3. **–•–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ max_tokens = 16384** ‚ö†Ô∏è

**–§–∞–π–ª:** `src/invoiceparser/services/gemini_client.py:200`

```python
def parse_with_prompt_file(
    self,
    image_path: Path,
    prompt_file_path: Path,
    additional_images: Optional[List[Path]] = None,
    max_tokens: int = 16384,  # ‚ö†Ô∏è –•–∞—Ä–¥–∫–æ–¥
    timeout: Optional[int] = None
) -> str:
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–æ –≤ —Å–∏–≥–Ω–∞—Ç—É—Ä–µ —Ñ—É–Ω–∫—Ü–∏–∏.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ config:
```python
max_tokens: Optional[int] = None,  # –ï—Å–ª–∏ None - –∏–∑ config
```

---

### 4. **–•–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ 50MB** ‚ö†Ô∏è

**–§–∞–π–ª:** `src/invoiceparser/adapters/web_api.py:219-220`

```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (50MB)
max_size = 50 * 1024 * 1024
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –õ–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í—ã–Ω–µ—Å—Ç–∏ –≤ config:
```python
# –í config.py
max_file_size_mb: int = Field(alias="MAX_FILE_SIZE_MB", default=50)

# –í web_api.py
max_size = self.config.max_file_size_mb * 1024 * 1024
```

---

### 5. **–•–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –≤ –ª–æ–≥–µ** ‚ö†Ô∏è

**–§–∞–π–ª:** `src/invoiceparser/services/orchestrator.py:461`

```python
logger.info(f"DETAILED mode: 2 parallel requests with gemini-2.5-pro, total time: {total_elapsed:.2f}s")
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–æ –≤ —Å—Ç—Ä–æ–∫–µ –ª–æ–≥–∞, —Ö–æ—Ç—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `self.config.gemini_model`.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ config:
```python
logger.info(f"DETAILED mode: 2 parallel requests with {self.config.gemini_model}, total time: {total_elapsed:.2f}s")
```

---

### 6. **–•–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ 4096 –≤ file_ops.py** ‚úÖ –ù–û–†–ú–ê–õ–¨–ù–û

**–§–∞–π–ª:** `src/invoiceparser/utils/file_ops.py:38`

```python
for byte_block in iter(lambda: f.read(4096), b""):
```

**–°—Ç–∞—Ç—É—Å:** –≠—Ç–æ —Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ), –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –≤—ã–Ω–æ—Å–∞ –≤ config.

---

## ‚úÖ –ß—Ç–æ –ù–ï —è–≤–ª—è–µ—Ç—Å—è —Ö–∞—Ä–¥–∫–æ–¥–æ–º (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)

### 1. **–î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ config.py** ‚úÖ

```python
web_host: str = Field(alias="WEB_HOST", default="0.0.0.0")
web_port: int = Field(alias="WEB_PORT", default=8000)
gemini_model_fast: str = Field(alias="GEMINI_MODEL_FAST", default="gemini-2.0-flash-exp")
```

**–°—Ç–∞—Ç—É—Å:** –≠—Ç–æ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–µ—Ä–µ–∑ `.env`. –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ.

---

### 2. **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ–º –∑–Ω–∞—á–µ–Ω–∏–π** ‚úÖ

```python
max_tokens=None  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ config (90000)
```

**–°—Ç–∞—Ç—É—Å:** –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏, –Ω–µ —Ö–∞—Ä–¥–∫–æ–¥.

---

### 3. **–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –æ—à–∏–±–æ–∫ ERROR_E*** ‚úÖ

```python
raise GeminiAPIError("ERROR_E001|–°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω...")
```

**–°—Ç–∞—Ç—É—Å:** –≠—Ç–æ –∫–æ–¥—ã –æ—à–∏–±–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞–º–∏. –ü—Ä–∞–≤–∏–ª—å–Ω–æ.

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- **–ö—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ö–∞—Ä–¥–∫–æ–¥–æ–≤:** 5
- **–ù–µ–∫—Ä–∏—Ç–∏—á–Ω—ã—Ö:** 0
- **–õ–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π:** 1 (4096 - —Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞)

---

## üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö—Ä–∏—Ç–∏—á–Ω–æ)

1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—É—Ç—å `/app/src`** - –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É –≤ —Ä–∞–∑–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è—Ö
2. **–í—ã–Ω–µ—Å—Ç–∏ –ª–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ –≤ config** - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ)

3. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å "Bearer " —Å—Ç—Ä–æ–∫—É** - —É–ª—É—á—à–∏—Ç —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å
4. **–£–±—Ä–∞—Ç—å –¥–µ—Ñ–æ–ª—Ç max_tokens=16384** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å config
5. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –ª–æ–≥ —Å –º–æ–¥–µ–ª—å—é** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å config –≤–º–µ—Å—Ç–æ —Ö–∞—Ä–¥–∫–æ–¥–∞

---

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ù–∞–π–¥–µ–Ω–æ **5 –º–µ—Å—Ç —Å —Ö–∞—Ä–¥–∫–æ–¥–æ–º**, –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö:
- **2 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö** (–ø—É—Ç—å –∏ –ª–∏–º–∏—Ç —Ñ–∞–π–ª–∞)
- **3 –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω—ã—Ö** (–º–æ–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–æ–¥–∞)

–í —Ü–µ–ª–æ–º –∫–æ–¥ —Ö–æ—Ä–æ—à–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω, –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –∑–Ω–∞—á–µ–Ω–∏–π –≤—ã–Ω–µ—Å–µ–Ω–æ –≤ config. –ù–∞–π–¥–µ–Ω–Ω—ã–π —Ö–∞—Ä–¥–∫–æ–¥ –Ω–µ –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º—ã, –Ω–æ –µ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–ª—É—á—à–∏—Ç –≥–∏–±–∫–æ—Å—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å.

