<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
        .log { margin: 5px 0; padding: 5px; }
        .error { color: #f44336; }
        .success { color: #4caf50; }
        .warning { color: #ff9800; }
        .info { color: #2196f3; }
        pre { background: #2d2d2d; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üß™ –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞</h1>
    <div id="logs"></div>

    <script>
        const logs = document.getElementById('logs');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = message;
            logs.appendChild(div);
            console.log(message);
        }

        function logObject(label, obj) {
            log(`${label}:`, 'info');
            const pre = document.createElement('pre');
            pre.textContent = JSON.stringify(obj, null, 2);
            logs.appendChild(pre);
        }

        async function testFullFlow() {
            log('üöÄ –ù–∞—á–∏–Ω–∞—é –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞...', 'info');
            log('', 'info');

            try {
                // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ API
                log('1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ API...', 'info');
                const validationResp = await fetch('/api/validate-frontend');
                const validation = await validationResp.json();
                logObject('–†–µ–∑—É–ª—å—Ç–∞—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏', validation);

                if (!validation.success) {
                    log('‚ùå –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ –ø—Ä–æ—à–ª–∞!', 'error');
                    return;
                }
                log('‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–π–¥–µ–Ω–∞', 'success');
                log('', 'info');

                // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
                log('2Ô∏è‚É£ –ó–∞–≥—Ä—É–∂–∞–µ–º lakover.jpg...', 'info');
                const fileResp = await fetch('/static/../invoices/lakover.jpg');
                const blob = await fileResp.blob();
                log(`‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω: ${blob.size} bytes`, 'success');
                log('', 'info');

                // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ø–∞—Ä—Å–∏–Ω–≥
                log('3Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ø–∞—Ä—Å–∏–Ω–≥...', 'info');
                const formData = new FormData();
                formData.append('file', blob, 'lakover.jpg');

                const token = 'mytoken'; // –ò–∑ .env
                const parseResp = await fetch('/parse', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                log(`–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${parseResp.status}`, parseResp.ok ? 'success' : 'error');

                if (!parseResp.ok) {
                    const error = await parseResp.json();
                    logObject('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞', error);
                    return;
                }

                const parseData = await parseResp.json();
                log('‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ —É—Å–ø–µ—à–µ–Ω!', 'success');
                log('', 'info');

                // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞
                log('4Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–≤–µ—Ç–∞...', 'info');
                logObject('–ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç', parseData);

                if (!parseData.success) {
                    log('‚ùå success = false', 'error');
                    return;
                }

                if (!parseData.data) {
                    log('‚ùå data –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç', 'error');
                    return;
                }

                log('‚úÖ success = true', 'success');
                log('‚úÖ data –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç', 'success');
                log('', 'info');

                // 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–∏ –≤ data
                log('5Ô∏è‚É£ –ö–ª—é—á–∏ –≤ data:', 'info');
                const dataKeys = Object.keys(parseData.data);
                log(`–ù–∞–π–¥–µ–Ω–æ ${dataKeys.length} –∫–ª—é—á–µ–π: ${dataKeys.join(', ')}`, 'info');
                log('', 'info');

                // 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é —Å–µ–∫—Ü–∏—é
                const data = parseData.data;

                log('6Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ü–∏–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', 'info');

                // document_info
                if (data.document_info) {
                    const fields = Object.keys(data.document_info).filter(k => !k.endsWith('_label'));
                    log(`‚úÖ document_info: ${fields.length} –ø–æ–ª–µ–π`, 'success');
                    log(`   –ü–æ–ª—è: ${fields.join(', ')}`, 'info');
                } else {
                    log('‚ùå document_info –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç', 'error');
                }

                // parties
                if (data.parties) {
                    if (data.parties.supplier) {
                        const fields = Object.keys(data.parties.supplier).filter(k => !k.endsWith('_label'));
                        log(`‚úÖ parties.supplier: ${fields.length} –ø–æ–ª–µ–π`, 'success');
                    }
                    const buyer = data.parties.buyer || data.parties.customer;
                    if (buyer) {
                        const fields = Object.keys(buyer).filter(k => !k.endsWith('_label'));
                        log(`‚úÖ parties.buyer/customer: ${fields.length} –ø–æ–ª–µ–π`, 'success');
                    }
                } else {
                    log('‚ùå parties –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç', 'error');
                }

                // totals
                if (data.totals) {
                    const fields = Object.keys(data.totals);
                    log(`‚úÖ totals: ${fields.length} –ø–æ–ª–µ–π (${fields.join(', ')})`, 'success');
                } else {
                    log('‚ö†Ô∏è totals –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç', 'warning');
                }

                // items
                let items = data.line_items || data.items || [];
                let column_mapping = data.column_mapping || {};

                if (data.table_data) {
                    items = data.table_data.line_items || data.table_data.items || items;
                    column_mapping = data.table_data.column_mapping || column_mapping;
                    log(`‚úÖ –¢–æ–≤–∞—Ä—ã –Ω–∞–π–¥–µ–Ω—ã –≤ table_data`, 'success');
                }

                if (items && items.length > 0) {
                    log(`‚úÖ –¢–æ–≤–∞—Ä—ã: ${items.length} —à—Ç`, 'success');
                    log(`   –ü–æ–ª—è –≤ —Ç–æ–≤–∞—Ä–µ: ${Object.keys(items[0]).join(', ')}`, 'info');
                    if (column_mapping && Object.keys(column_mapping).length > 0) {
                        log(`‚úÖ column_mapping: ${Object.keys(column_mapping).length} –∫–æ–ª–æ–Ω–æ–∫`, 'success');
                    } else {
                        log(`‚ö†Ô∏è column_mapping –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç`, 'warning');
                    }
                } else {
                    log('‚ö†Ô∏è –¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'warning');
                }

                log('', 'info');
                log('7Ô∏è‚É£ –≠–º—É–ª—è—Ü–∏—è displayEditableData()...', 'info');

                // –≠–º—É–ª–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é displayEditableData
                let fieldCount = 0;

                // document_info
                if (data.document_info) {
                    for (const [key, value] of Object.entries(data.document_info)) {
                        if (!key.endsWith('_label') && typeof value !== 'object') {
                            fieldCount++;
                        }
                    }
                }

                // parties
                if (data.parties) {
                    if (data.parties.supplier) {
                        for (const [key, value] of Object.entries(data.parties.supplier)) {
                            if (!key.endsWith('_label') && typeof value !== 'object') {
                                fieldCount++;
                            }
                        }
                    }
                    const buyer = data.parties.buyer || data.parties.customer;
                    if (buyer) {
                        for (const [key, value] of Object.entries(buyer)) {
                            if (!key.endsWith('_label') && typeof value !== 'object') {
                                fieldCount++;
                            }
                        }
                    }
                }

                // references
                if (data.references) {
                    for (const [key, value] of Object.entries(data.references)) {
                        if (!key.endsWith('_label') && typeof value !== 'object') {
                            fieldCount++;
                        }
                    }
                }

                // totals
                if (data.totals) {
                    for (const [key, value] of Object.entries(data.totals)) {
                        if (typeof value !== 'object') {
                            fieldCount++;
                        }
                    }
                }

                log(`‚úÖ –î–æ–ª–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å—Å—è ${fieldCount} —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã—Ö –ø–æ–ª–µ–π`, 'success');
                log(`‚úÖ –ü–ª—é—Å —Ç–∞–±–ª–∏—Ü–∞ —Å ${items.length} —Ç–æ–≤–∞—Ä–∞–º–∏`, 'success');
                log('', 'info');

                log('8Ô∏è‚É£ –ò–¢–û–ì–û–í–ê–Ø –ü–†–û–í–ï–†–ö–ê:', 'info');
                log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');

                if (fieldCount > 0) {
                    log('‚úÖ –î–∞–Ω–Ω—ã–µ –µ—Å—Ç—å –∏ –≥–æ—Ç–æ–≤—ã –∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—é!', 'success');
                    log(`‚úÖ –í—Å–µ–≥–æ –ø–æ–ª–µ–π: ${fieldCount}`, 'success');
                    log(`‚úÖ –¢–æ–≤–∞—Ä–æ–≤: ${items.length}`, 'success');
                    log('', 'info');
                    log('‚ùó –ï–°–õ–ò –ü–û–õ–Ø –ü–£–°–¢–´–ï –ù–ê –ì–õ–ê–í–ù–û–ô –°–¢–†–ê–ù–ò–¶–ï:', 'warning');
                    log('   1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)', 'warning');
                    log('   2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —ç–ª–µ–º–µ–Ω—Ç #editableData –≤ DOM', 'warning');
                    log('   3. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ displayEditableData() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è', 'warning');
                    log('   4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –Ω–µ—Ç –æ—à–∏–±–æ–∫ JavaScript', 'warning');
                } else {
                    log('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è!', 'error');
                }

            } catch (error) {
                log(`‚ùå –û–®–ò–ë–ö–ê: ${error.message}`, 'error');
                log(error.stack, 'error');
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç
        testFullFlow();
    </script>
</body>
</html>

