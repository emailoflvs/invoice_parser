# Telegram Bot - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

## üì± –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç Telegram –±–æ—Ç

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ç–æ

–ö–æ–≥–¥–∞ –≤—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç–µ —Ñ–æ—Ç–æ –≤ Telegram –±–æ—Ç—É, –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–ª–µ–¥—É—é—â–µ–µ:

#### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
```python
if not self._is_authorized(user_id):
    await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É.")
    return
```

**–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:**
- –í–∞—à Telegram User ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Å–ø–∏—Å–∫–µ `TELEGRAM_ALLOWED_USER_IDS` –≤ `.env`
- –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç ‚Üí –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω –≤—Å–µ–º (–Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ!)

#### 2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
```python
if update.message.photo:
    file = await update.message.photo[-1].get_file()  # –ë–µ—Ä–µ—Ç—Å—è —Å–∞–º–æ–µ –±–æ–ª—å—à–æ–µ —Ñ–æ—Ç–æ
    file_name = f"photo_{update.message.photo[-1].file_id}.jpg"
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑–º–µ—Ä–æ–≤ —Ñ–æ—Ç–æ
- –ë–æ—Ç –±–µ—Ä–µ—Ç —Å–∞–º–æ–µ –±–æ–ª—å—à–æ–µ (–ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤ –º–∞—Å—Å–∏–≤–µ `photo[-1]`)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ `.jpg`

#### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞
```python
allowed_extensions = ['.pdf', '.jpg', '.jpeg', '.png', '.tiff', '.bmp']
if file_ext not in allowed_extensions:
    await update.message.reply_text("‚ùå –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞")
    return
```

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:**
- PDF
- JPG/JPEG
- PNG
- TIFF
- BMP

#### 4. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
```python
status_message = await update.message.reply_text(
    "‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞...\n"
    "–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 30 —Å–µ–∫—É–Ω–¥."
)
```

#### 5. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
```python
with tempfile.NamedTemporaryFile(
    delete=False,
    suffix=file_ext,
    dir=self.config.temp_dir
) as tmp_file:
    await file.download_to_drive(tmp_file.name)
    tmp_path = Path(tmp_file.name)
```

**–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:**
- –í–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é (`temp_dir`)
- –° –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏

#### 6. –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
```python
result = await self.orchestrator.process_document(tmp_path)
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –î–æ–∫—É–º–µ–Ω—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `Orchestrator`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–∂–∏–º "detailed" (–¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑)
- –ò–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞
- –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)

#### 7. –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

**–ü—Ä–∏ —É—Å–ø–µ—Ö–µ:**
```python
response_text = (
    "‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω —É—Å–ø–µ—à–Ω–æ!\n\n"
    f"üìã –ù–æ–º–µ—Ä —Å—á–µ—Ç–∞: {data.header.invoice_number}\n"
    f"üìÖ –î–∞—Ç–∞: {data.header.date}\n"
    f"üè¢ –ü–æ—Å—Ç–∞–≤—â–∏–∫: {data.header.supplier_name}\n"
    f"üí∞ –°—É–º–º–∞: {data.header.total_amount}\n"
    f"üì¶ –ü–æ–∑–∏—Ü–∏–π: {len(data.items)}"
)
```

**–¢–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è:**
- JSON —Ñ–∞–π–ª —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- –ò–º—è —Ñ–∞–π–ª–∞: `{invoice_number}.json`

**–ü—Ä–∏ –æ—à–∏–±–∫–µ:**
```python
user_message = "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç."
# –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ .env

```env
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_ALLOWED_USER_IDS=123456789,987654321
```

**–ì–¥–µ –≤–∑—è—Ç—å:**
- `TELEGRAM_BOT_TOKEN` - —Å–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ [@BotFather](https://t.me/BotFather)
- `TELEGRAM_ALLOWED_USER_IDS` - –≤–∞—à Telegram User ID (–º–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å —á–µ—Ä–µ–∑ [@userinfobot](https://t.me/userinfobot))

### –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞

```bash
# –í Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
docker-compose exec app python -m invoiceparser.app.main_telegram
```

–ò–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º –≤ `docker-compose.yml`.

## üìã –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞

- `/start` - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- `/help` - –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
- `/info` - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

1. **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:**
   - –ë–µ–∑ `TELEGRAM_ALLOWED_USER_IDS` –¥–æ—Å—Ç—É–ø –æ—Ç–∫—Ä—ã—Ç –≤—Å–µ–º (–Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ!)
   - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏—Ç–µ —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ:**
   - –ë–µ—Ä–µ—Ç—Å—è —Å–∞–º–æ–µ –±–æ–ª—å—à–æ–µ —Ñ–æ—Ç–æ –∏–∑ –º–∞—Å—Å–∏–≤–∞
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ JPG
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –æ–±—ã—á–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç

3. **–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
   - –§–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `temp_dir`
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏

4. **–û—à–∏–±–∫–∏:**
   - –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
   - –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–æ–∫ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º—É

## üîÑ –ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏

```
Telegram ‚Üí –ë–æ—Ç ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ‚Üí –ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ ‚Üí
–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Üí Orchestrator ‚Üí –û–±—Ä–∞–±–æ—Ç–∫–∞ ‚Üí –†–µ–∑—É–ª—å—Ç–∞—Ç ‚Üí Telegram
```

## üìù –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –±–æ—Ç—É
2. –ü–æ–ª—É—á–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ "‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞..."
3. –ß–µ—Ä–µ–∑ 10-30 —Å–µ–∫—É–Ω–¥ –ø–æ–ª—É—á–∏—Ç–µ:
   - –ö—Ä–∞—Ç–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ–∫—É–º–µ–Ω—Ç–µ
   - JSON —Ñ–∞–π–ª —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ë–æ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ñ–æ—Ç–æ –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ Telegram:
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ç–æ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ Orchestrator
- ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** ü§ñ

