#!/usr/bin/env python3
"""
–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ø–∞—Ä—Å–µ—Ä –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –∏ —Ç–æ–≤–∞—Ä–æ–≤
–≠–∫—Å–ø–æ—Ä—Ç –≤ —Ñ–æ—Ä–º–∞—Ç —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–µ –≤ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ
"""

import json
import sys
import anthropic
import os
import base64
from pathlib import Path
import xlwt
from datetime import datetime

def parse_invoice_complete(pdf_path: str) -> dict:
    """
    –ü–∞—Ä—Å–∏—Ç PDF –∏–Ω–≤–æ–π—Å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON —Å —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏ –∏ —Ç–æ–≤–∞—Ä–∞–º–∏
    """
    api_key = os.getenv('ANTHROPIC_API_KEY')
    if not api_key:
        raise ValueError("ANTHROPIC_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")

    client = anthropic.Anthropic(api_key=api_key)

    # –ß–∏—Ç–∞–µ–º PDF —Ñ–∞–π–ª
    with open(pdf_path, 'rb') as f:
        pdf_data = f.read()

    # –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
    with open('task-items-advanced.txt', 'r', encoding='utf-8') as f:
        system_prompt = f.read()

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ Claude —Å PDF (—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º streaming)
    print(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ Claude API...")

    response_text = ""

    with client.messages.stream(
        model="claude-sonnet-4-20250514",
        max_tokens=32000,
        system=system_prompt,
        messages=[
            {
                "role": "user",
                "content": [
                    {
                        "type": "document",
                        "source": {
                            "type": "base64",
                            "media_type": "application/pdf",
                            "data": base64.standard_b64encode(pdf_data).decode('utf-8')
                        }
                    },
                    {
                        "type": "text",
                        "text": "–ò–∑—É—á–∏ invoice.pdf: —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∞–∫—Ç, –Ω–∞–∫–ª–∞–¥–Ω–∞—è –∏–ª–∏ –∏–Ω–≤–æ–π—Å. –ò–∑–≤–ª–µ–∫–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –ò —Ç–∞–±–ª–∏—Ü—É —Ç–æ–≤–∞—Ä–æ–≤. –í–ê–ñ–ù–û: –∏–∑–≤–ª–µ–∫–∏ –í–°–ï —Ç–æ–≤–∞—Ä—ã, –¥–∞–∂–µ –µ—Å–ª–∏ –∏—Ö —Å–æ—Ç–Ω–∏."
                    }
                ]
            }
        ],
        timeout=600.0
    ) as stream:
        for text in stream.text_stream:
            response_text += text
            print(".", end="", flush=True)

    print()

    # –ü–∞—Ä—Å–∏–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
    try:
        json_start = response_text.find('{')
        json_end = response_text.rfind('}') + 1
        json_str = response_text[json_start:json_end]
        result = json.loads(json_str)

        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Ç–æ–≤–∞—Ä–æ–≤
        count_info = response_text[json_end:].strip()
        if count_info:
            result['_info'] = count_info

        return result
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: {e}", file=sys.stderr)
        print(f"–û—Ç–≤–µ—Ç: {response_text[:500]}...", file=sys.stderr)
        return {"header": {}, "items": [], "error": str(e)}


def export_to_excel_advanced(data: dict, excel_file: str, pdf_filename: str):
    """
    –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç Excel —Å —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª
    if Path(excel_file).exists():
        import xlrd
        from xlutils.copy import copy as xl_copy

        try:
            rb = xlrd.open_workbook(excel_file, formatting_info=True)
            wb = xl_copy(rb)
            sheet = wb.get_sheet(0)
            start_row = rb.sheet_by_index(0).nrows
        except:
            wb = xlwt.Workbook(encoding='utf-8')
            sheet = wb.add_sheet('–¢–æ–≤–∞—Ä—ã')
            start_row = 0
    else:
        wb = xlwt.Workbook(encoding='utf-8')
        sheet = wb.add_sheet('–¢–æ–≤–∞—Ä—ã')
        start_row = 0

    # –°—Ç–∏–ª–∏
    header_style = xlwt.easyxf('font: bold 1; align: horiz center')
    normal_style = xlwt.easyxf()

    # –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å, –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
    if start_row == 0:
        headers = [
            '–ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫',
            '–∫–æ–¥ –Ñ–î–†–ü–û–£',
            '—Ç–µ–ª–µ—Ñ–æ–Ω',
            '–∞–¥—Ä–µ—Å–∞',
            '–¥–∞—Ç–∞ –Ω–∞–∫–ª–∞–¥–Ω–æ—ó',
            '–Ω–æ–º–µ—Ä –Ω–∞–∫–ª–∞–¥–Ω–æ—ó',
            '–£–ö–¢ –ó–ï–î',
            '–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞',
            '–æ–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (–Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞, –∞—Ä—Ç–∏–∫–ª—å)',
            '—Ü—ñ–Ω–∞ –∑–∞ —à—Ç –±–µ–∑ –ø–¥–≤',
            '–∫—ñ–ª-—Å—Ç—å —à—Ç—É–∫',
            '—Å—É–º–∞ –±–µ–∑ –ø–¥–≤',
            '—Ü—ñ–Ω–∞ –∑–∞ –æ–¥–∏–Ω–∏—Ü—é –∑ –ü–î–í',
            '—Å—É–º–∞ –∑ –ü–î–í'
        ]
        for col, header in enumerate(headers):
            sheet.write(0, col, header, header_style)
        start_row = 1

    # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
    header = data.get('header', {})
    postachalnyk = header.get('postachalnyk', '')
    kod_edrpu = header.get('kod_edrpu', '')
    telefon = header.get('telefon', '')
    adresa = header.get('adresa', '')
    data_nakladnoi = header.get('data_nakladnoi', '')
    nomer_nakladnoi = header.get('nomer_nakladnoi', '')

    # –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–≤–∞—Ä–∞—Ö
    items = data.get('items', [])

    for idx, item in enumerate(items):
        row = start_row + idx

        # –†–µ–∫–≤–∏–∑–∏—Ç—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ (–ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞)
        sheet.write(row, 0, postachalnyk, normal_style)
        sheet.write(row, 1, kod_edrpu, normal_style)
        sheet.write(row, 2, telefon, normal_style)
        sheet.write(row, 3, adresa, normal_style)
        sheet.write(row, 4, data_nakladnoi, normal_style)
        sheet.write(row, 5, nomer_nakladnoi, normal_style)

        # –î–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞
        sheet.write(row, 6, item.get('ukt_zed', ''), normal_style)
        sheet.write(row, 7, item.get('naimenovanie_tovara', ''), normal_style)
        sheet.write(row, 8, item.get('oboznachennya_tovara', ''), normal_style)
        sheet.write(row, 9, item.get('tsina_za_sht_bez_pdv', ''), normal_style)
        sheet.write(row, 10, item.get('kilkist_shtuk', ''), normal_style)
        sheet.write(row, 11, item.get('suma_bez_pdv', ''), normal_style)
        sheet.write(row, 12, item.get('tsina_za_odynytsyu_z_pdv', ''), normal_style)
        sheet.write(row, 13, item.get('suma_z_pdv', ''), normal_style)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
    wb.save(excel_file)
    print(f"‚úì –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ {len(items)} —Ç–æ–≤–∞—Ä–æ–≤ –≤ {excel_file}")


def process_invoice(pdf_path: str, excel_file: str = "—Ç–∞–±–ª–∏—Ü—è –Ω–∞–∫–ª–∞–¥–Ω–∏—Ö.xls"):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–¥–∏–Ω –∏–Ω–≤–æ–π—Å: –ø–∞—Ä—Å–∏—Ç –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –≤ Excel
    """
    print(f"\n{'='*60}")
    print(f"–û–±—Ä–∞–±–æ—Ç–∫–∞: {pdf_path}")
    print(f"{'='*60}")

    # –ü–∞—Ä—Å–∏–º –∏–Ω–≤–æ–π—Å
    result = parse_invoice_complete(pdf_path)

    if 'error' in result:
        print(f"‚úó –û—à–∏–±–∫–∞: {result['error']}")
        return result

    # –í—ã–≤–æ–¥–∏–º –∫—Ä–∞—Ç–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    header = result.get('header', {})
    items_count = len(result.get('items', []))

    print(f"\nüìã –†–µ–∫–≤–∏–∑–∏—Ç—ã:")
    print(f"  –ü–æ—Å—Ç–∞–≤—â–∏–∫: {header.get('postachalnyk', 'N/A')}")
    print(f"  –Ñ–î–†–ü–û–£: {header.get('kod_edrpu', 'N/A')}")
    print(f"  –î–∞—Ç–∞: {header.get('data_nakladnoi', 'N/A')}")
    print(f"  –ù–æ–º–µ—Ä: {header.get('nomer_nakladnoi', 'N/A')}")
    print(f"\nüì¶ –¢–æ–≤–∞—Ä–æ–≤: {items_count}")

    # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ Excel
    pdf_filename = Path(pdf_path).name
    export_to_excel_advanced(result, excel_file, pdf_filename)

    return result


def process_multiple_invoices(pdf_paths: list, excel_file: str = "—Ç–∞–±–ª–∏—Ü—è –Ω–∞–∫–ª–∞–¥–Ω–∏—Ö.xls"):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω–≤–æ–π—Å–æ–≤
    """
    total_items = 0
    success_count = 0
    failed_count = 0

    for pdf_path in pdf_paths:
        try:
            result = process_invoice(pdf_path, excel_file)
            if 'error' not in result:
                total_items += len(result.get('items', []))
                success_count += 1
            else:
                failed_count += 1
        except Exception as e:
            print(f"‚úó –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ {pdf_path}: {e}\n")
            failed_count += 1

    print(f"\n{'='*60}")
    print(f"üìä –ò–¢–û–ì–ò")
    print(f"{'='*60}")
    print(f"‚úì –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {success_count} —Ñ–∞–π–ª–æ–≤")
    print(f"‚úó –û—à–∏–±–æ–∫: {failed_count}")
    print(f"üì¶ –í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤: {total_items}")
    print(f"üíæ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã: {excel_file}")
    print(f"{'='*60}\n")


def main():
    if len(sys.argv) < 2:
        print("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:")
        print("  python3 advanced_parser.py <–ø—É—Ç—å_–∫_pdf> [output.xls]")
        print("  python3 advanced_parser.py <–ø—É—Ç—å1.pdf> <–ø—É—Ç—å2.pdf> ... [output.xls]")
        print("  python3 advanced_parser.py invoices/*.pdf")
        sys.exit(1)

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª Excel
    excel_file = "—Ç–∞–±–ª–∏—Ü—è –Ω–∞–∫–ª–∞–¥–Ω–∏—Ö.xls"
    pdf_paths = []

    for arg in sys.argv[1:]:
        if arg.endswith('.xls'):
            excel_file = arg
        else:
            pdf_paths.append(arg)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
    valid_paths = []
    for pdf_path in pdf_paths:
        if Path(pdf_path).exists():
            valid_paths.append(pdf_path)
        else:
            print(f"‚ö† –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {pdf_path}")

    if not valid_paths:
        print("‚úó –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –≤–∞–ª–∏–¥–Ω–æ–≥–æ PDF —Ñ–∞–π–ª–∞")
        sys.exit(1)

    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª—ã
    if len(valid_paths) == 1:
        process_invoice(valid_paths[0], excel_file)
    else:
        process_multiple_invoices(valid_paths, excel_file)


if __name__ == "__main__":
    main()
