# üî¨ –ö–û–ú–ü–õ–ï–ö–°–ù–´–ô –ê–ù–ê–õ–ò–ó –ü–†–û–ì–†–ê–ú–ú–´ –ò –ë–ê–ó–´ –î–ê–ù–ù–´–•

**–î–∞—Ç–∞:** 2025-12-13
**–°—Ç–∞—Ç—É—Å:** –ü—Ä–æ–µ–∫—Ç –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ, –ë–î –ø—É—Å—Ç–∞—è
**–ú–∞—Å—à—Ç–∞–±:** >1M –∑–∞–ø–∏—Å–µ–π, –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å, —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å

---

## I. –û–ë–ó–û–† –ê–†–•–ò–¢–ï–ö–¢–£–†–´ –ü–†–û–ì–†–ê–ú–ú–´

### 1.1 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
invoice_parser/
‚îú‚îÄ‚îÄ src/invoiceparser/
‚îÇ   ‚îú‚îÄ‚îÄ adapters/          # –í–Ω–µ—à–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã (CLI, Web API, Telegram, Email)
‚îÇ   ‚îú‚îÄ‚îÄ app/               # –¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ core/              # –Ø–¥—Ä–æ (–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, –æ—à–∏–±–∫–∏, –º–æ–¥–µ–ª–∏)
‚îÇ   ‚îú‚îÄ‚îÄ database/          # –†–∞–±–æ—Ç–∞ —Å –ë–î (–º–æ–¥–µ–ª–∏, —Å–µ—Ä–≤–∏—Å, –º–∏–≥—Ä–∞—Ü–∏–∏)
‚îÇ   ‚îú‚îÄ‚îÄ exporters/         # –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (JSON, Excel)
‚îÇ   ‚îú‚îÄ‚îÄ infra/             # –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
‚îÇ   ‚îú‚îÄ‚îÄ preprocessing/     # –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ (PDF, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)
‚îÇ   ‚îú‚îÄ‚îÄ services/          # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (Gemini, –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä, –ø–æ—Å—Ç-–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥)
‚îÇ   ‚îî‚îÄ‚îÄ utils/             # –£—Ç–∏–ª–∏—Ç—ã (—Ñ–∞–π–ª—ã, –¥–∞—Ç–∞/–≤—Ä–µ–º—è, JSON)
‚îú‚îÄ‚îÄ alembic/               # –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
‚îú‚îÄ‚îÄ static/                # Frontend (HTML, CSS, JS)
‚îú‚îÄ‚îÄ prompts/               # AI –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
‚îî‚îÄ‚îÄ tests/                 # –¢–µ—Å—Ç—ã
```

### 1.2 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø–æ–¥—Ö–æ–¥

**Clean Architecture / Hexagonal Architecture:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              ADAPTERS (–ü–æ—Ä—Ç—ã)               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ Web API  ‚îÇ  ‚îÇ   CLI   ‚îÇ  ‚îÇTelegram ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ       ‚îÇ             ‚îÇ             ‚îÇ         ‚îÇ
‚îÇ       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îÇ                     ‚îÇ                       ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ ‚îÇ         ORCHESTRATOR                 ‚îÇ   ‚îÇ
‚îÇ ‚îÇ  (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏)        ‚îÇ   ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ     ‚îÇ      ‚îÇ      ‚îÇ         ‚îÇ              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   SERVICES (–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îê ‚îå‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇGemini‚îÇ ‚îÇPreProc‚îÇ ‚îÇPostProc‚îÇ ‚îÇExporter‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ           DATABASE LAYER                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ   DatabaseService + Models         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   (ORM, –º–∏–≥—Ä–∞—Ü–∏–∏, CRUD)           ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:**
- **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏**: –∫–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–≤–æ—é –∑–∞–¥–∞—á—É
- **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –≤–Ω—É—Ç—Ä—å**: –∞–¥–∞–ø—Ç–µ—Ä—ã –∑–∞–≤–∏—Å—è—Ç –æ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏, –Ω–æ –Ω–µ –Ω–∞–æ–±–æ—Ä–æ—Ç
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å**: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `asyncio` –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏
- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º–æ—Å—Ç—å**: –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–µ–∑ `.env` (Pydantic Settings)

---

## II. –ê–ù–ê–õ–ò–ó –ö–õ–Æ–ß–ï–í–´–• –ö–û–ú–ü–û–ù–ï–ù–¢–û–í

### 2.1 Orchestrator (–û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏)

**–§–∞–π–ª:** `src/invoiceparser/services/orchestrator.py`

**–§—É–Ω–∫—Ü–∏–∏:**
```python
async def process_document(
    document_path: Path,
    mode: str = "detailed"  # "fast" –∏–ª–∏ "detailed"
) -> Dict[str, Any]
```

**Workflow –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞:**

```
1. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
   ‚Üì
2. –ü—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥ (PDF ‚Üí –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, —É–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞)
   ‚Üì
3. –í—ã–∑–æ–≤ Gemini AI (–ø–∞—Ä—Å–∏–Ω–≥)
   ‚îú‚îÄ‚îÄ Fast mode: 1 –∑–∞–ø—Ä–æ—Å (header+items.txt)
   ‚îî‚îÄ‚îÄ Detailed mode: 2 –∑–∞–ø—Ä–æ—Å–∞ (header.txt + items.txt)
   ‚Üì
4. –ü–æ—Å—Ç-–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥ (–≤–∞–ª–∏–¥–∞—Ü–∏—è, –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è)
   ‚Üì
5. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î (DatabaseService)
   ‚Üì
6. –≠–∫—Å–ø–æ—Ä—Ç (JSON, Excel)
```

**‚úÖ –ü–õ–Æ–°–´:**
- –ß–µ—Ç–∫–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–≤—É—Ö —Ä–µ–∂–∏–º–æ–≤ (—Å–∫–æ—Ä–æ—Å—Ç—å vs —Ç–æ—á–Ω–æ—Å—Ç—å)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –ø–∞—Ä—Å–∏–Ω–≥–∞

**‚ùå –ú–ò–ù–£–°–´:**
- –ù–µ—Ç retry –º–µ—Ö–∞–Ω–∏–∑–º–∞ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö Gemini API
- –ù–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞)
- –ù–µ—Ç –ø–∞–∫–µ—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ (batch processing)

**üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:**
1. –î–æ–±–∞–≤–∏—Ç—å retry —Å exponential backoff –¥–ª—è Gemini API
2. –î–æ–±–∞–≤–∏—Ç—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ `file_hash`
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å batch processing –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Ñ–∞–π–ª–æ–≤

---

### 2.2 Gemini Client (AI –ü–∞—Ä—Å–∏–Ω–≥)

**–§–∞–π–ª:** `src/invoiceparser/services/gemini_client.py`

**–§—É–Ω–∫—Ü–∏–∏:**
- –í—ã–∑–æ–≤ Gemini API —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
- –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ–º–ø—Ç–æ–≤
- –ü–∞—Ä—Å–∏–Ω–≥ JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞

**–ü—Ä–æ–º–ø—Ç—ã:**
- `header.txt` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (parties, totals, signatures)
- `items_v13.txt` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ –∫–æ–ª–æ–Ω–∫–∞–º–∏

**‚úÖ –ü–õ–Æ–°–´:**
- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è –ª—é–±—ã—Ö —è–∑—ã–∫–æ–≤ –∏ —Ç–∏–ø–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä (unknown fields, dynamic columns)
- –ú–µ—Ö–∞–Ω–∏–∑–º `column_mapping` –¥–ª—è –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
- RAW —Ñ–∏–∫—Å–∞—Ü–∏—è: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ _label –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞

**‚ùå –ú–ò–ù–£–°–´:**
- –ù–µ—Ç fallback –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–æ–¥–µ–ª–∏ (GPT, Claude) –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Gemini
- –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ JSON schema –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞ (—Ç–æ–ª—å–∫–æ –ø–æ—Å—Ç-–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥)
- –ñ–µ—Å—Ç–∫–æ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ Gemini (vendor lock-in)

**üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:**
1. –î–æ–±–∞–≤–∏—Ç—å –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—é `AIProvider` —Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è–º–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
2. –î–æ–±–∞–≤–∏—Ç—å JSON schema –≤–∞–ª–∏–¥–∞—Ü–∏—é –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤

---

### 2.3 DatabaseService (–†–∞–±–æ—Ç–∞ —Å –ë–î)

**–§–∞–π–ª:** `src/invoiceparser/database/service.py`

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**

```python
# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
async def save_parsed_document(
    file_path: Path,
    json_data: Dict[str, Any],
    original_filename: Optional[str] = None
) -> int

# –ü–æ–∏—Å–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
async def search_documents_by_text(...)
async def search_documents_by_table_value(...)
async def search_documents_by_metadata(...)

# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏—è–º–∏
async def create_or_update_company(...)
async def find_company_by_tax_id(...)
```

**–ê–ª–≥–æ—Ä–∏—Ç–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:**

```
1. –°–æ–∑–¥–∞–Ω–∏–µ File record (–ø—É—Ç—å, hash, mime_type)
   ‚Üì
2. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (DocumentType)
   ‚Üì
3. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏ —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–π
   ‚îú‚îÄ‚îÄ –ü–æ–∏—Å–∫ –ø–æ tax_id
   ‚îî‚îÄ‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π
   ‚Üì
4. –°–æ–∑–¥–∞–Ω–∏–µ Document record
   ‚Üì
5. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ RAW snapshot (–ø–æ–ª–Ω—ã–π JSON)
   ‚Üì
6. –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ DocumentFields (–≤–∫–ª—é—á–∞—è unknown fields)
   ‚îú‚îÄ‚îÄ field_id = NULL –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø–æ–ª–µ–π
   ‚îî‚îÄ‚îÄ raw_label —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –º–µ—Ç–∫—É
   ‚Üì
7. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ signatures (–º–∞—Å—Å–∏–≤ –ø–æ–¥–ø–∏—Å–µ–π)
   ‚Üì
8. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ table_sections (column_mapping + rows)
   ‚Üì
9. –°–æ–∑–¥–∞–Ω–∏–µ DocumentPages (–¥–ª—è PDF: —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –¥–ª—è image: 1 —Å—Ç—Ä–∞–Ω–∏—Ü–∞)
```

**‚úÖ –ü–õ–Æ–°–´:**
- –ü–æ–ª–Ω–∞—è —Ñ–∏–∫—Å–∞—Ü–∏—è RAW –¥–∞–Ω–Ω—ã—Ö (snapshot)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø–æ–ª–µ–π (field_id=NULL)
- –ì–∏–±–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü —á–µ—Ä–µ–∑ `column_mapping`
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `_label` –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –¥–ª—è UI
- –°–æ–∑–¥–∞–Ω–∏–µ DocumentPages –¥–ª—è OCR –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏

**‚ùå –ú–ò–ù–£–°–´:**
- –î—É–±–ª–∏–∫–∞—Ç—ã –∫–æ–º–ø–∞–Ω–∏–π (–Ω–µ—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ `tax_id`)
- –ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã—Ö –≥–∞—Ä–∞–Ω—Ç–∏–π (rollback –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ–π –æ—à–∏–±–∫–µ)
- –ú–µ–¥–ª–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–º–Ω–æ–≥–æ INSERT –∑–∞–ø—Ä–æ—Å–æ–≤)
- –ù–µ—Ç bulk insert –¥–ª—è –ø–æ–ª–µ–π –∏ —Ç–∞–±–ª–∏—Ü

**üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:**
1. –î–æ–±–∞–≤–∏—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é `tax_id` (—É–±—Ä–∞—Ç—å –ø—Ä–µ—Ñ–∏–∫—Å—ã, –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —á–∏—Å–ª–æ–≤–æ–º—É –≤–∏–¥—É)
2. –û–±–µ—Ä–Ω—É—Ç—å –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å bulk insert –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
4. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ –∏–º–µ–Ω–∏ (–µ—Å–ª–∏ `tax_id` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)

---

### 2.4 Web API (REST API + Frontend)

**–§–∞–π–ª:** `src/invoiceparser/adapters/web_api.py`

**Endpoints:**

```python
POST /parse?mode=fast|detailed  # –ü–∞—Ä—Å–∏–Ω–≥ —Ñ–∞–π–ª–∞
POST /save                       # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
GET /health                      # Health check
GET /static/{file}              # –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã (no-cache)
```

**Frontend:** `static/index.html`, `static/script.js`, `static/style.css`

**‚úÖ –ü–õ–Æ–°–´:**
- –ü—Ä–æ—Å—Ç–æ–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π API
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ CORS
- No-cache –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ (—É–¥–æ–±–Ω–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
- –ö—Ä–∞—Å–∏–≤—ã–π UI —Å drag-and-drop
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ RAW –∏ APPROVED –¥–∞–Ω–Ω—ã—Ö

**‚ùå –ú–ò–ù–£–°–´:**
- –ù–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π `WEB_AUTH_TOKEN`)
- –ù–µ—Ç rate limiting
- –ù–µ—Ç –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- –ù–µ—Ç WebSocket –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- –ë–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Ü–µ–ª–∏–∫–æ–º –≤ –ø–∞–º—è—Ç—å

**üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:**
1. –î–æ–±–∞–≤–∏—Ç—å JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –¥–ª—è production
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å rate limiting (Redis –∏–ª–∏ in-memory)
3. –î–æ–±–∞–≤–∏—Ç—å WebSocket –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞
4. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å streaming upload –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
5. –î–æ–±–∞–≤–∏—Ç—å endpoint –¥–ª—è —Å–ø–∏—Å–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏

---

## III. –ê–ù–ê–õ–ò–ó –ë–ê–ó–´ –î–ê–ù–ù–´–•

### 3.1 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ë–î

**–ü–æ–¥—Ö–æ–¥:** –ì–∏–±—Ä–∏–¥–Ω–∞—è —Å—Ö–µ–º–∞ (EAV + JSONB + Normalized)

**–¢–∞–±–ª–∏—Ü—ã:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           REFERENCE TABLES (–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏)        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ document_types          - –¢–∏–ø—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤       ‚îÇ
‚îÇ field_definitions       - –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø–æ–ª—è        ‚îÇ
‚îÇ field_labels           - –ü–µ—Ä–µ–≤–æ–¥—ã –ø–æ–ª–µ–π         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           COMPANY DATA (–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã)            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ companies              - –ö–æ–º–ø–∞–Ω–∏–∏               ‚îÇ
‚îÇ company_document_profiles - ML –ø—Ä–æ—Ñ–∏–ª–∏          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           DOCUMENT FLOW (–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ files                  - –§–∏–∑–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã       ‚îÇ
‚îÇ documents              - –î–æ–∫—É–º–µ–Ω—Ç—ã (–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ) ‚îÇ
‚îÇ document_pages         - –°—Ç—Ä–∞–Ω–∏—Ü—ã (OCR text)    ‚îÇ
‚îÇ document_snapshots     - JSON —Å–Ω–∏–º–∫–∏ (RAW/APPROVED) ‚îÇ
‚îÇ document_fields        - –ü–æ–ª—è (EAV + RAW/APPROVED) ‚îÇ
‚îÇ document_signatures    - –ü–æ–¥–ø–∏—Å–∏                ‚îÇ
‚îÇ document_table_sections - –¢–∞–±–ª–∏—Ü—ã (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–æ–ª–æ–Ω–∫–∏) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (12 –ø–∞—Ä—Ç–∏—Ü–∏–π):**

| –¢–∞–±–ª–∏—Ü–∞                  | –¢–∏–ø          | –ö–ª—é—á         | –ü–∞—Ä—Ç–∏—Ü–∏–∏ |
|--------------------------|--------------|--------------|----------|
| documents                | RANGE        | created_at   | 2025, 2026 |
| document_fields          | HASH         | document_id  | p0-p3 (4 —à—Ç) |
| document_snapshots       | RANGE        | created_at   | 2025, 2026 |
| document_table_sections  | HASH         | document_id  | p0-p3 (4 —à—Ç) |

**–ò–Ω–¥–µ–∫—Å—ã (19 –∏–Ω–¥–µ–∫—Å–æ–≤):**
- B-Tree: —Å—Ç–∞—Ç—É—Å—ã, –¥–∞—Ç—ã, FK
- GIN (JSONB): parsing_metadata, rows_raw, rows_approved, settings
- GIN (FTS): ocr_text, legal_name (3 —è–∑—ã–∫–∞: simple, russian, english)

---

### 3.2 –ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ë–î

#### 3.2.1 RAW vs APPROVED Pattern

**–ò–¥–µ—è:** –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç AI (RAW) –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö —á–µ–ª–æ–≤–µ–∫–æ–º (APPROVED)

```sql
-- DocumentField
raw_value_text        TEXT      -- –æ—Ç AI
approved_value_text   TEXT      -- –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
is_corrected          BOOLEAN   -- —Ñ–ª–∞–≥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–¥–ª—è ML –æ–±—É—á–µ–Ω–∏—è!)

-- DocumentTableSection
rows_raw              JSONB[]   -- –æ—Ç AI
rows_approved         JSONB[]   -- –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
column_mapping_raw    JSONB     -- –æ—Ç AI
column_mapping_approved JSONB   -- –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
```

**‚úÖ –ü–õ–Æ–°–´:**
- –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è Human-in-the-Loop
- ML –º–æ–∂–µ—Ç —É—á–∏—Ç—å—Å—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö (`is_corrected = true`)
- –ú–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è –∫ RAW –¥–∞–Ω–Ω—ã–º
- –ê—É–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π

---

#### 3.2.2 EAV Pattern –¥–ª—è DocumentFields

**–ò–¥–µ—è:** –ì–∏–±–∫–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª—é–±—ã—Ö –ø–æ–ª–µ–π (–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö)

```sql
CREATE TABLE document_fields (
    id BIGINT PRIMARY KEY,
    document_id BIGINT,
    field_id INT,              -- NULL –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø–æ–ª–µ–π!
    field_code VARCHAR(100),   -- NULL –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø–æ–ª–µ–π!
    section VARCHAR(50),       -- header, supplier, buyer, totals, other
    raw_label TEXT,            -- –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –º–µ—Ç–∫–∞ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞
    section_label TEXT,        -- _label –∏–∑ JSON (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫:")
    raw_value_text TEXT,
    ...
)
```

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

| field_id | field_code      | section   | raw_label          | raw_value_text              |
|----------|-----------------|-----------|--------------------|-----------------------------|
| 1        | invoice_number  | header    | –ù–æ–º–µ—Ä –Ω–∞–∫–ª–∞–¥–Ω–æ—ó    | 00000017                    |
| 2        | supplier_name   | supplier  | name               | –¢–ï–•–ù–û - –ü–†–ò–í–Ü–î              |
| NULL     | NULL            | other     | –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ –æ—Å–æ–±–∞    | –Ü–≤–∞–Ω–æ–≤ –Ü–≤–∞–Ω                 |

**‚úÖ –ü–õ–Æ–°–´:**
- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å: –ª—é–±—ã–µ –ø–æ–ª—è, –ª—é–±—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
- –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø–æ–ª—è –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è (field_id=NULL, raw_label —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç–∏ (field_labels)

**‚ùå –ú–ò–ù–£–°–´:**
- –°–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (JOIN –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞)
- –ú–µ–¥–ª–µ–Ω–Ω–µ–µ —á–µ–º –¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è
- –ù–µ—Ç —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î (–≤—Å–µ TEXT)

---

#### 3.2.3 Dynamic Tables —á–µ—Ä–µ–∑ column_mapping

**–ò–¥–µ—è:** –¢–∞–±–ª–∏—Ü—ã —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ –∫–æ–ª–æ–Ω–∫–∞–º–∏ –¥–ª—è –ª—é–±—ã—Ö —è–∑—ã–∫–æ–≤

```json
{
  "column_mapping": {
    "no": "‚Ññ",
    "ukt_zed": "–£–ö–¢ –ó–ï–î",
    "tovar": "–¢–æ–≤–∞—Ä",
    "kilkist": "–ö—ñ–ª—å–∫—ñ—Å—Ç—å"
  },
  "line_items": [
    {"no": 1, "ukt_zed": "8501510090", "tovar": "–ú–æ—Ç–æ—Ä...", "kilkist": "2 —à—Ç"},
    {"no": 2, "ukt_zed": "8501510090", "tovar": "–†–µ–¥—É–∫—Ç–æ—Ä...", "kilkist": "1 —à—Ç"}
  ]
}
```

**–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î:**

```sql
CREATE TABLE document_table_sections (
    id BIGINT PRIMARY KEY,
    document_id BIGINT,
    section_name VARCHAR(100),        -- 'line_items'
    column_mapping_raw JSONB,         -- {"no": "‚Ññ", ...}
    rows_raw JSONB,                   -- [{"no": 1, ...}, ...]
    column_mapping_approved JSONB,
    rows_approved JSONB
)
```

**‚úÖ –ü–õ–Æ–°–´:**
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –õ–Æ–ë–´–• —Ç–∞–±–ª–∏—Ü –∏–∑ –õ–Æ–ë–´–• –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å "–∏–∑ –∫–æ—Ä–æ–±–∫–∏"
- GIN –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ JSONB
- –ù–µ –Ω—É–∂–Ω—ã –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫

**‚ùå –ú–ò–ù–£–°–´:**
- –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
- –°–ª–æ–∂–Ω–µ–µ –¥–µ–ª–∞—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É (–Ω—É–∂–Ω—ã JSONB —Ñ—É–Ω–∫—Ü–∏–∏)

---

### 3.3 –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ë–î

#### 3.3.1 –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

**‚úÖ –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- `documents` –ø–æ `created_at` ‚Üí –±—ã—Å—Ç—Ä–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–∞—Ç–∞–º
- `document_fields` –ø–æ `document_id` ‚Üí –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
- `document_table_sections` –ø–æ `document_id` ‚Üí –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
- `document_snapshots` –ø–æ `created_at` ‚Üí –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**‚úÖ GIN –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ JSONB:**
- `rows_raw`, `rows_approved` ‚Üí –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É —Ç–∞–±–ª–∏—Ü
- `parsing_metadata` ‚Üí —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≤–µ—Ä—Å–∏—è–º –º–æ–¥–µ–ª–µ–π
- `settings` ‚Üí –ø–æ–∏—Å–∫ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π

**‚úÖ FTS –∏–Ω–¥–µ–∫—Å—ã:**
- `document_pages.ocr_text` (3 —è–∑—ã–∫–∞) ‚Üí –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫
- `companies.legal_name` (3 —è–∑—ã–∫–∞) ‚Üí –ø–æ–∏—Å–∫ –∫–æ–º–ø–∞–Ω–∏–π

**‚úÖ Composite –∏–Ω–¥–µ–∫—Å—ã:**
- `(document_id, section)` –Ω–∞ `document_fields`
- `(document_id, page_number)` –Ω–∞ `document_pages`

#### 3.3.2 –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

**‚ùå –ù–µ—Ç FTS –∏–Ω–¥–µ–∫—Å–æ–≤ –Ω–∞ `document_fields.raw_value_text`:**

–ü—Ä–æ–±–ª–µ–º–∞:
```python
# –≠—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –±—É–¥–µ—Ç –º–µ–¥–ª–µ–Ω–Ω—ã–º –Ω–∞ 1M –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:
await search_documents_by_text("12345")
```

–†–µ—à–µ–Ω–∏–µ:
```sql
CREATE INDEX idx_document_fields_raw_value_fts_simple
ON document_fields USING GIN (to_tsvector('simple', COALESCE(raw_value_text, '')));
```

**‚ùå –ù–µ—Ç –¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–ª–µ–π –≤ `documents`:**

–ü—Ä–æ–±–ª–µ–º–∞:
```python
# –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è invoice_number –Ω—É–∂–µ–Ω JOIN:
SELECT d.*, df.raw_value_text as invoice_number
FROM documents d
LEFT JOIN document_fields df ON df.document_id = d.id AND df.field_code = 'invoice_number'
```

–†–µ—à–µ–Ω–∏–µ:
```sql
ALTER TABLE documents ADD COLUMN invoice_number VARCHAR(100);
ALTER TABLE documents ADD COLUMN total_amount NUMERIC(30, 10);
-- –û–±–Ω–æ–≤–ª—è—Ç—å –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ
```

**‚ùå –î—É–±–ª–∏–∫–∞—Ç—ã –∫–æ–º–ø–∞–Ω–∏–π:**

–ü—Ä–æ–±–ª–µ–º–∞:
```sql
-- –û–¥–Ω–∞ –∫–æ–º–ø–∞–Ω–∏—è, –Ω–æ 3 –∑–∞–ø–∏—Å–∏:
ID 1: tax_id = NULL, legal_name = "–¢–ï–•–ù–û - –ü–†–ò–í–Ü–î"
ID 4: tax_id = '37483556', legal_name = "–¢–ï–•–ù–û - –ü–†–ò–í–Ü–î"
ID 6: tax_id = '–∫–æ–¥ –∑–∞ –Ñ–î–†–ü–û–£ 37483556', legal_name = "–¢–û–í–ê–†–ò–°–¢–í–û..."
```

–†–µ—à–µ–Ω–∏–µ:
```python
def normalize_tax_id(tax_id: str) -> str:
    """–£–±—Ä–∞—Ç—å –ø—Ä–µ—Ñ–∏–∫—Å—ã, –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã"""
    import re
    numbers = re.findall(r'\d+', tax_id)
    return numbers[0] if numbers else None
```

---

## IV. –û–¶–ï–ù–ö–ê –ü–û –ö–†–ò–¢–ï–†–ò–Ø–ú

### 4.1 –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å (>1M –∑–∞–ø–∏—Å–µ–π)

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç                | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|--------------------------|--------|-------------|
| –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ        | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | –û—Ç–ª–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| –ò–Ω–¥–µ–∫—Å—ã                  | ‚≠ê‚≠ê‚≠ê‚≠ê  | –•–æ—Ä–æ—à–æ, –Ω–æ –Ω–µ—Ç FTS –Ω–∞ fields |
| –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è           | ‚≠ê‚≠ê    | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç |
| Connection pooling       | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | pool_size=50, max_overflow=20 |
| Async I/O                | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ |

**–ò—Ç–æ–≥–æ: ‚≠ê‚≠ê‚≠ê‚≠ê (4/5)** - —Ö–æ—Ä–æ—à–æ, –Ω–æ –Ω—É–∂–Ω–∞ –¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏ FTS –∏–Ω–¥–µ–∫—Å—ã

---

### 4.2 –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç                | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|--------------------------|--------|-------------|
| –ü—Ä–æ–º–ø—Ç—ã AI               | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ, –±–µ–∑ –ø—Ä–∏–º–µ—Ä–æ–≤ |
| column_mapping           | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –ª—é–±—ã—Ö —è–∑—ã–∫–æ–≤ |
| field_labels —Ç–∞–±–ª–∏—Ü–∞     | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | –ü–µ—Ä–µ–≤–æ–¥—ã –¥–ª—è –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø–æ–ª–µ–π |
| FTS –∏–Ω–¥–µ–∫—Å—ã              | ‚≠ê‚≠ê‚≠ê‚≠ê  | 3 —è–∑—ã–∫–∞, –Ω–æ –º–æ–∂–Ω–æ –±–æ–ª—å—à–µ |
| UI                       | ‚≠ê‚≠ê‚≠ê   | –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ç–æ–ª—å–∫–æ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º |

**–ò—Ç–æ–≥–æ: ‚≠ê‚≠ê‚≠ê‚≠ê (4.2/5)** - –æ—Ç–ª–∏—á–Ω–∞—è –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ –¥–∞–Ω–Ω—ã—Ö

---

### 4.3 –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å (–¥–ª—è –ª—é–±—ã—Ö —Ç–∏–ø–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç                | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|--------------------------|--------|-------------|
| EAV –¥–ª—è –ø–æ–ª–µ–π            | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | Unknown fields –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è |
| Dynamic tables           | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | column_mapping –¥–ª—è –ª—é–±—ã—Ö —Ç–∞–±–ª–∏—Ü |
| DocumentType             | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ |
| Signatures               | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | –ú–∞—Å—Å–∏–≤, –ª—é–±–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ |
| –ü—Ä–æ–º–ø—Ç—ã                  | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ, –±–µ–∑ hard-code |

**–ò—Ç–æ–≥–æ: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5/5)** - –∏–¥–µ–∞–ª—å–Ω–∞—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å

---

### 4.4 –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç                | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|--------------------------|--------|-------------|
| –ü–∞—Ä—Å–∏–Ω–≥ (AI)             | ‚≠ê‚≠ê‚≠ê   | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç Gemini API |
| –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î          | ‚≠ê‚≠ê‚≠ê   | –ú–µ–¥–ª–µ–Ω–Ω–æ–µ (–º–Ω–æ–≥–æ INSERT) |
| –ü–æ–∏—Å–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤         | ‚≠ê‚≠ê‚≠ê   | –ë–µ–∑ FTS –∏–Ω–¥–µ–∫—Å–æ–≤ –Ω–∞ fields |
| –ü–æ–∏—Å–∫ –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö         | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | GIN –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ JSONB |
| –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–∞—Ç–∞–º      | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ created_at |

**–ò—Ç–æ–≥–æ: ‚≠ê‚≠ê‚≠ê (3.4/5)** - —Å—Ä–µ–¥–Ω—è—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –Ω—É–∂–Ω—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

---

### 4.5 –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞

| –ö—Ä–∏—Ç–µ—Ä–∏–π                 | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|--------------------------|--------|-------------|
| –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞              | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | Clean Architecture |
| –¢–∏–ø–∏–∑–∞—Ü–∏—è                | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | Pydantic, SQLAlchemy 2.0 |
| –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ              | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | –í–µ–∑–¥–µ logger |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫         | ‚≠ê‚≠ê‚≠ê‚≠ê  | –•–æ—Ä–æ—à–æ, –Ω–æ –Ω–µ—Ç retry |
| –¢–µ—Å—Ç—ã                    | ‚≠ê‚≠ê‚≠ê   | –ï—Å—Ç—å, –Ω–æ –º–∞–ª–æ –ø–æ–∫—Ä—ã—Ç–∏–µ |
| –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è             | ‚≠ê‚≠ê‚≠ê‚≠ê  | –•–æ—Ä–æ—à–∏–µ docstring |

**–ò—Ç–æ–≥–æ: ‚≠ê‚≠ê‚≠ê‚≠ê (4.3/5)** - –≤—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞

---

## V. –ü–õ–Æ–°–´ –ò –ú–ò–ù–£–°–´

### ‚úÖ –°–ò–õ–¨–ù–´–ï –°–¢–û–†–û–ù–´ –ü–†–û–ì–†–ê–ú–ú–´

1. **–ì–∏–±–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
   - Clean Architecture ‚Üí –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∞–¥–∞–ø—Ç–µ—Ä—ã
   - Async/await ‚Üí –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
   - Pydantic Settings ‚Üí –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º–æ—Å—Ç—å

2. **–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å:**
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ª—é–±—ã—Ö —è–∑—ã–∫–æ–≤
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ª—é–±—ã—Ö —Ç–∏–ø–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ª—é–±—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä —Ç–∞–±–ª–∏—Ü (dynamic columns)
   - Unknown fields –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è

3. **Human-in-the-Loop:**
   - RAW vs APPROVED pattern
   - `is_corrected` —Ñ–ª–∞–≥ –¥–ª—è ML –æ–±—É—á–µ–Ω–∏—è
   - Snapshots –¥–ª—è –∞—É–¥–∏—Ç–∞

4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –ë–î:**
   - –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (12 –ø–∞—Ä—Ç–∏—Ü–∏–π)
   - GIN –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ JSONB
   - FTS –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø–æ–∏—Å–∫–∞
   - Connection pooling

5. **–ö–∞—á–µ—Å—Ç–≤–æ –ø—Ä–æ–º–ø—Ç–æ–≤:**
   - –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ (–±–µ–∑ –ø—Ä–∏–º–µ—Ä–æ–≤)
   - ABSOLUTE ABSTRACTION –ø—Ä–∞–≤–∏–ª–æ
   - Safety net: "raw" –∫–æ–ª–æ–Ω–∫–∞ –¥–ª—è unmapped –¥–∞–Ω–Ω—ã—Ö
   - `column_mapping` –¥–ª—è –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç–∏

6. **Frontend:**
   - –ö—Ä–∞—Å–∏–≤—ã–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π UI
   - Drag-and-drop
   - Real-time –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
   - –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º

---

### ‚ùå –°–õ–ê–ë–´–ï –°–¢–û–†–û–ù–´ –ü–†–û–ì–†–ê–ú–ú–´

#### –ö—Ä–∏—Ç–∏—á–Ω—ã–µ (—Ç—Ä–µ–±—É—é—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –î–û production):

1. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏–π:**
   - –°–∏—Å—Ç–µ–º–∞ —É–ø–∞–¥–µ—Ç –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö —Å –¥–∞—Ç–æ–π, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –ø–∞—Ä—Ç–∏—Ü–∏–∏
   - –ú–∏–≥—Ä–∞—Ü–∏—è 008 —Å–æ–∑–¥–∞–Ω–∞, –Ω–æ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
   - **–†–ò–°–ö:** –ø–æ–ª–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ production

2. **–ù–µ—Ç FTS –∏–Ω–¥–µ–∫—Å–æ–≤ –Ω–∞ `document_fields.raw_value_text`:**
   - –ü–æ–∏—Å–∫ –ø–æ –ø–æ–ª—è–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω—ã–π
   - –ú–µ—Ç–æ–¥ `search_documents_by_text()` –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω
   - **–†–ò–°–ö:** –Ω–µ–ø—Ä–∏–≥–æ–¥–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞

3. **–î—É–±–ª–∏–∫–∞—Ç—ã –∫–æ–º–ø–∞–Ω–∏–π:**
   - –ù–µ—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ `tax_id`
   - –ü–æ–∏—Å–∫ —Ç–æ–ª—å–∫–æ –ø–æ `tax_id` (–µ—Å–ª–∏ NULL ‚Üí –Ω–æ–≤–∞—è –∫–æ–º–ø–∞–Ω–∏—è)
   - **–†–ò–°–ö:** –ø–æ—Ç–µ—Ä—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏, –∏—Å–∫–∞–∂–µ–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

4. **–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:**
   - –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ ‚Üí —á–∞—Å—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ë–î
   - –ù–µ—Ç rollback
   - **–†–ò–°–ö:** inconsistent data

#### –í–∞–∂–Ω—ã–µ (—Å–Ω–∏–∂–∞—é—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å):

5. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–ª–µ–π:**
   - –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è `invoice_number`, `total_amount` –Ω—É–∂–µ–Ω JOIN
   - –î–∞—à–±–æ—Ä–¥—ã –±—É–¥—É—Ç –º–µ–¥–ª–µ–Ω–Ω—ã–º–∏
   - **–†–ò–°–ö:** –º–µ–¥–ª–µ–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç—ã –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è

6. **–ú–µ–¥–ª–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:**
   - –ú–Ω–æ–≥–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö INSERT –∑–∞–ø—Ä–æ—Å–æ–≤
   - –ù–µ—Ç bulk insert
   - **–†–ò–°–ö:** –Ω–∏–∑–∫–∞—è throughput

7. **–ù–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è:**
   - –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ —Ç–æ–≥–æ –∂–µ —Ñ–∞–π–ª–∞ ‚Üí –ø–æ–≤—Ç–æ—Ä–Ω—ã–π AI –≤—ã–∑–æ–≤
   - –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤
   - **–†–ò–°–ö:** –ª–∏—à–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ AI API

8. **–ù–µ—Ç retry –º–µ—Ö–∞–Ω–∏–∑–º–∞:**
   - –ü—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Gemini API ‚Üí –ø–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞
   - –ù–µ—Ç exponential backoff
   - **–†–ò–°–ö:** –ø–æ—Ç–µ—Ä—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑-–∑–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ–µ–≤

#### –ñ–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ (—É–ª—É—á—à–µ–Ω–∏—è UX):

9. **–ù–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:**
   - –¢–æ–ª—å–∫–æ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π token
   - –ù–µ—Ç user management
   - **–†–ò–°–ö:** –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è production

10. **–ù–µ—Ç WebSocket:**
    - –ù–µ–ª—å–∑—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤ real-time
    - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–Ω–∞–µ—Ç, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
    - **–†–ò–°–ö:** –ø–ª–æ—Ö–æ–π UX –¥–ª—è –¥–æ–ª–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

11. **Vendor lock-in –Ω–∞ Gemini:**
    - –ñ–µ—Å—Ç–∫–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –æ–¥–Ω–æ–π AI –º–æ–¥–µ–ª–∏
    - –ù–µ—Ç fallback –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã
    - **–†–ò–°–ö:** –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –æ–¥–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

---

## VI. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### üî¥ –ö–†–ò–¢–ò–ß–ù–û (—Å–¥–µ–ª–∞—Ç—å –î–û –∑–∞–ø—É—Å–∫–∞ –≤ production):

1. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –∞–≤—Ç–æ-—Å–æ–∑–¥–∞–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏–π:**
   ```bash
   alembic upgrade head  # –ü—Ä–∏–º–µ–Ω–∏—Ç—å 008_auto_create_partitions.py
   ```
   **–ë–µ–∑ —ç—Ç–æ–≥–æ —Å–∏—Å—Ç–µ–º–∞ —É–ø–∞–¥–µ—Ç!**

2. **–î–æ–±–∞–≤–∏—Ç—å FTS –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ `document_fields.raw_value_text`:**
   ```sql
   -- –ú–∏–≥—Ä–∞—Ü–∏—è 009_add_fts_indexes.py
   CREATE INDEX idx_document_fields_raw_value_fts_simple
   ON document_fields USING GIN (to_tsvector('simple', COALESCE(raw_value_text, '')));

   CREATE INDEX idx_document_fields_raw_value_fts_ru
   ON document_fields USING GIN (to_tsvector('russian', COALESCE(raw_value_text, '')))
   WHERE language IN ('ru', 'uk');  -- Partial index
   ```

3. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã –∫–æ–º–ø–∞–Ω–∏–π:**
   ```python
   # –í DatabaseService.create_or_update_company()
   def normalize_tax_id(tax_id: str) -> str:
       if not tax_id:
           return None
       import re
       numbers = re.findall(r'\d+', tax_id)
       return numbers[0] if numbers else None

   # –ü–æ–∏—Å–∫ –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É tax_id:
   normalized = normalize_tax_id(tax_id)
   if normalized:
       company = await find_company_by_tax_id(session, normalized)

   # –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –∏—Å–∫–∞—Ç—å –ø–æ –∏–º–µ–Ω–∏:
   if not company and legal_name:
       company = await find_company_by_name(session, legal_name)
   ```

4. **–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:**
   ```python
   async def save_parsed_document(...):
       async with session.begin():  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback –ø—Ä–∏ –æ—à–∏–±–∫–µ
           try:
               # –í–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
               file = await self._create_file(...)
               doc = await self._create_document(...)
               await self._populate_fields(...)
               await session.commit()
           except Exception as e:
               await session.rollback()
               raise
   ```

---

### üü° –í–ê–ñ–ù–û (—Å–¥–µ–ª–∞—Ç—å –≤ –ø–µ—Ä–≤—ã–µ –º–µ—Å—è—Ü—ã):

5. **–î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è:**
   ```sql
   -- –ú–∏–≥—Ä–∞—Ü–∏—è 011_denormalize_documents.py
   ALTER TABLE documents ADD COLUMN invoice_number VARCHAR(100);
   ALTER TABLE documents ADD COLUMN invoice_date DATE;
   ALTER TABLE documents ADD COLUMN total_amount NUMERIC(30, 10);
   ALTER TABLE documents ADD COLUMN currency CHAR(3);
   ALTER TABLE documents ADD COLUMN supplier_name TEXT;
   ALTER TABLE documents ADD COLUMN buyer_name TEXT;

   CREATE INDEX idx_documents_invoice_number ON documents(invoice_number);
   CREATE INDEX idx_documents_invoice_date ON documents(invoice_date);
   CREATE INDEX idx_documents_total_amount ON documents(total_amount);
   ```

   –û–±–Ω–æ–≤–ª—è—Ç—å –≤ `DatabaseService.save_parsed_document()`:
   ```python
   # –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è document
   doc.invoice_number = self._extract_field_value(json_data, 'invoice_number')
   doc.total_amount = self._extract_field_value(json_data, 'total_amount')
   # ...
   ```

6. **–î–æ–±–∞–≤–∏—Ç—å bulk insert:**
   ```python
   # –í _populate_raw_fields():
   fields_to_create = [...]  # –°–æ–±—Ä–∞—Ç—å –≤—Å–µ –ø–æ–ª—è
   session.add_all(fields_to_create)  # ‚úÖ –£–∂–µ –µ—Å—Ç—å!
   await session.flush()

   # –ù–û –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å bulk_insert_mappings –¥–ª—è –µ—â–µ –±–æ–ª—å—à–µ–π —Å–∫–æ—Ä–æ—Å—Ç–∏:
   await session.execute(
       insert(DocumentField),
       [
           {"document_id": doc_id, "field_code": "name", ...},
           {"document_id": doc_id, "field_code": "address", ...},
           # ...
       ]
   )
   ```

7. **–î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:**
   ```python
   # –í Orchestrator.process_document():
   file_hash = get_file_hash(document_path)

   # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –±—ã–ª –ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω —ç—Ç–æ—Ç hash:
   existing_doc = await self.db_service.find_document_by_file_hash(
       session, file_hash
   )
   if existing_doc and not force_reparse:
       logger.info(f"Document already parsed: {file_hash}")
       return existing_doc.to_dict()
   ```

8. **–î–æ–±–∞–≤–∏—Ç—å retry –º–µ—Ö–∞–Ω–∏–∑–º:**
   ```python
   # –í GeminiClient:
   from tenacity import retry, stop_after_attempt, wait_exponential

   @retry(
       stop=stop_after_attempt(3),
       wait=wait_exponential(multiplier=1, min=2, max=10)
   )
   async def parse_with_gemini(self, ...):
       # AI –≤—ã–∑–æ–≤
   ```

---

### üü¢ –ñ–ï–õ–ê–¢–ï–õ–¨–ù–û (–∫–æ–≥–¥–∞ –ë–î –≤—ã—Ä–∞—Å—Ç–µ—Ç):

9. **–î–æ–±–∞–≤–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é:**
   ```python
   # JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
   from fastapi_jwt_auth import AuthJWT

   @app.post("/login")
   async def login(username: str, password: str, Authorize: AuthJWT = Depends()):
       # –ü—Ä–æ–≤–µ—Ä–∫–∞ credentials
       access_token = Authorize.create_access_token(subject=username)
       return {"access_token": access_token}

   @app.post("/parse")
   async def parse(file: UploadFile, Authorize: AuthJWT = Depends()):
       Authorize.jwt_required()  # –¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–∫–µ–Ω
       current_user = Authorize.get_jwt_subject()
       # ...
   ```

10. **–î–æ–±–∞–≤–∏—Ç—å WebSocket –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:**
    ```python
    @app.websocket("/ws/parse/{task_id}")
    async def websocket_parse(websocket: WebSocket, task_id: str):
        await websocket.accept()
        # –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        await websocket.send_json({"status": "preprocessing", "progress": 10})
        await websocket.send_json({"status": "ai_parsing", "progress": 50})
        await websocket.send_json({"status": "saving", "progress": 90})
        await websocket.send_json({"status": "completed", "progress": 100})
    ```

11. **–ê–±—Å—Ç—Ä–∞–≥–∏—Ä–æ–≤–∞—Ç—å AI Provider:**
    ```python
    # –°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    class AIProvider(ABC):
        @abstractmethod
        async def parse_document(self, image: bytes, prompt: str) -> dict:
            pass

    # –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏
    class GeminiProvider(AIProvider):
        async def parse_document(self, image: bytes, prompt: str) -> dict:
            # Gemini –ª–æ–≥–∏–∫–∞

    class GPTProvider(AIProvider):
        async def parse_document(self, image: bytes, prompt: str) -> dict:
            # GPT –ª–æ–≥–∏–∫–∞

    # –í config:
    ai_provider: Literal["gemini", "gpt", "claude"] = "gemini"
    ```

12. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏–µ OCR:**
    ```python
    # –í–∞—Ä–∏–∞–Ω—Ç 1: Compression
    import gzip

    ocr_text_compressed = gzip.compress(ocr_text.encode('utf-8'))
    # –°–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ –ë–î –∫–∞–∫ BYTEA

    # –í–∞—Ä–∏–∞–Ω—Ç 2: S3/MinIO
    # –°–æ—Ö—Ä–∞–Ω—è—Ç—å ocr_text –≤ S3, –≤ –ë–î —Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ URL
    ```

13. **–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π:**
    ```sql
    -- –ü–∞—Ä—Ç–∏—Ü–∏–∏ —Å—Ç–∞—Ä—à–µ N –ª–µ—Ç ‚Üí detach –∏ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å
    -- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ ARCHIVE_PARTITIONS_OLDER_THAN_YEARS –≤ .env

    ALTER TABLE documents DETACH PARTITION documents_2023;
    -- –≠–∫—Å–ø–æ—Ä—Ç –≤ S3 –∏–ª–∏ cold storage
    ```

---

## VII. –ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê

### –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞: ‚≠ê‚≠ê‚≠ê‚≠ê (4/5)

**–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:**

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è              | –û—Ü–µ–Ω–∫–∞ | –í–µ—Å  | –í–∑–≤–µ—à–µ–Ω–Ω–∞—è |
|------------------------|--------|------|------------|
| –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å       | 4/5    | 25%  | 1.0        |
| –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å        | 4.2/5  | 20%  | 0.84       |
| –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å        | 5/5    | 20%  | 1.0        |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å     | 3.4/5  | 20%  | 0.68       |
| –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞          | 4.3/5  | 15%  | 0.65       |
| **–ò–¢–û–ì–û**              |        | 100% | **4.17/5** |

---

### –í–µ—Ä–¥–∏–∫—Ç:

**–ü—Ä–æ–≥—Ä–∞–º–º–∞ –∏–º–µ–µ—Ç –æ—Ç–ª–∏—á–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—É—é –æ—Å–Ω–æ–≤—É –∏ –≥–æ—Ç–æ–≤–∞ –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é.**

**–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- –ì–∏–±–∫–∞—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- –û—Ç–ª–∏—á–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç–∏
- Human-in-the-Loop workflow
- –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ AI –ø—Ä–æ–º–ø—Ç—ã

**–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å:**
- –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏–π (–ö–†–ò–¢–ò–ß–ù–û!)
- –î–æ–±–∞–≤–∏—Ç—å FTS –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ document_fields (–ö–†–ò–¢–ò–ß–ù–û!)
- –ò—Å–ø—Ä–∞–≤–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã –∫–æ–º–ø–∞–Ω–∏–π (–ö–†–ò–¢–ò–ß–ù–û!)
- –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è (–í–ê–ñ–ù–û)
- –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ retry (–í–ê–ñ–ù–û)

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º ‚Üí –≥–æ—Ç–æ–≤–∞ –∫ production —Å 1M+ –∑–∞–ø–∏—Å–µ–π.**

---

## VIII. –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (1-2 –Ω–µ–¥–µ–ª–∏)

- [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é 008 (–∞–≤—Ç–æ-—Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π)
- [ ] –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é 009 (FTS –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ document_fields)
- [ ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã –∫–æ–º–ø–∞–Ω–∏–π (–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è tax_id)
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### –§–∞–∑–∞ 2: –í–∞–∂–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (2-3 –Ω–µ–¥–µ–ª–∏)

- [ ] –î–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è –≤ documents
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ file_hash
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è AI
- [ ] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å bulk insert
- [ ] –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –§–∞–∑–∞ 3: UX —É–ª—É—á—à–µ–Ω–∏—è (1-2 –Ω–µ–¥–µ–ª–∏)

- [ ] –î–æ–±–∞–≤–∏—Ç—å JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å WebSocket –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
- [ ] –î–æ–±–∞–≤–∏—Ç—å endpoint –¥–ª—è —Å–ø–∏—Å–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
- [ ] –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –∏ user-friendly —Å–æ–æ–±—â–µ–Ω–∏—è

### –§–∞–∑–∞ 4: Production –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å (1 –Ω–µ–¥–µ–ª—è)

- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Prometheus + Grafana)
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ centralized system (ELK/Loki)
- [ ] Backup —Å—Ç—Ä–∞—Ç–µ–≥–∏—è
- [ ] Disaster recovery –ø–ª–∞–Ω
- [ ] Load testing –Ω–∞ 1M+ –∑–∞–ø–∏—Å–µ–π

---

**–î–æ–∫—É–º–µ–Ω—Ç –≥–æ—Ç–æ–≤. –ñ–¥–µ–º —É–∫–∞–∑–∞–Ω–∏–π –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã!** üöÄ

