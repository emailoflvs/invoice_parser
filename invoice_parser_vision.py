#!/usr/bin/env python3
"""
–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ø–∞—Ä—Å–µ—Ä –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –∏ —Ç–æ–≤–∞—Ä–æ–≤
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç OpenAI GPT-4o Vision –¥–ª—è –ø—Ä—è–º–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ PDF –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
–≠–∫—Å–ø–æ—Ä—Ç –≤ —Ñ–æ—Ä–º–∞—Ç —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–µ –≤ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ
"""

import json
import sys
import os
import base64
from pathlib import Path
import xlwt
from dotenv import load_dotenv
from openai import OpenAI
from pdf2image import convert_from_path

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()


def parse_pdf_with_openai_vision(pdf_path: str, prompt_file: str) -> dict:
    """
    –ü–∞—Ä—Å–∏—Ç PDF –Ω–∞–ø—Ä—è–º—É—é –∏—Å–ø–æ–ª—å–∑—É—è OpenAI Vision API (GPT-4o)
    –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç PDF –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–∞—Ä—Ç–∏—è–º–∏ –≤ OpenAI
    """
    api_key = os.getenv('OPENAI_API_KEY')
    if not api_key:
        raise ValueError("OPENAI_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ .env")

    client = OpenAI(api_key=api_key)

    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–º–ø—Ç
    with open(prompt_file, 'r', encoding='utf-8') as f:
        system_prompt = f.read()

    print(f"–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è PDF –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...")
    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º PDF –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –Ω–∏–∑–∫–∏–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
    images = convert_from_path(pdf_path, dpi=100)
    print(f"–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ {len(images)} —Å—Ç—Ä–∞–Ω–∏—Ü")

    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ 3 —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞ —Ä–∞–∑ –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    batch_size = 3
    all_items = []
    header = {}

    for batch_start in range(0, len(images), batch_size):
        batch_end = min(batch_start + batch_size, len(images))
        batch_images = images[batch_start:batch_end]

        print(f"\n–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü {batch_start + 1}-{batch_end} (–ø–∞—Ä—Ç–∏—è {batch_start // batch_size + 1})...")

        # –ö–æ–¥–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–∞—Ä—Ç–∏–∏ –≤ base64
        image_messages = []
        for i, image in enumerate(batch_images):
            import io
            img_byte_arr = io.BytesIO()
            # –°–∂–∏–º–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ JPEG —Å –∫–∞—á–µ—Å—Ç–≤–æ–º 60% –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
            image.save(img_byte_arr, format='JPEG', quality=60, optimize=True)
            img_byte_arr = img_byte_arr.getvalue()

            size_kb = len(img_byte_arr) / 1024
            print(f"  –°—Ç—Ä–∞–Ω–∏—Ü–∞ {batch_start + i + 1}: {size_kb:.1f} KB")

            img_base64 = base64.b64encode(img_byte_arr).decode('utf-8')

            image_messages.append({
                "type": "image_url",
                "image_url": {
                    "url": f"data:image/jpeg;base64,{img_base64}",
                    "detail": "low"  # –ò—Å–ø–æ–ª—å–∑—É–µ–º low –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤
                }
            })

        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        messages_content = [
            {
                "type": "text",
                "text": "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–Ω–∞–∫–ª–∞–¥–Ω–æ–π/–∞–∫—Ç–∞/–∏–Ω–≤–æ–π—Å–∞) –∏ –∏–∑–≤–ª–µ–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é."
            }
        ] + image_messages

        print(f"  –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ OpenAI...")

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º GPT-4o —Å vision
        try:
            response = client.chat.completions.create(
                model="gpt-4o",
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": messages_content}
                ],
                temperature=0,
                max_tokens=16000,
                timeout=120.0  # 2 –º–∏–Ω—É—Ç—ã —Ç–∞–π–º–∞—É—Ç
            )

            response_text = response.choices[0].message.content

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            debug_file = f"{pdf_path}.batch_{batch_start // batch_size + 1}.txt"
            with open(debug_file, 'w', encoding='utf-8') as f:
                f.write(response_text)

            # –ü–∞—Ä—Å–∏–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
            json_start = response_text.find('{')
            json_end = response_text.rfind('}') + 1
            json_str = response_text[json_start:json_end]
            batch_data = json.loads(json_str)

            # –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            if not header:
                header = batch_data.get('header', {})

            batch_items = batch_data.get('items', [])
            all_items.extend(batch_items)

            print(f"  ‚úì –ò–∑–≤–ª–µ—á–µ–Ω–æ {len(batch_items)} —Ç–æ–≤–∞—Ä–æ–≤")

        except Exception as e:
            print(f"  ‚ö† –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–∞—Ä—Ç–∏–∏: {e}")
            continue

    return {
        "header": header,
        "items": all_items
    }


def parse_invoice_complete(pdf_path: str) -> dict:
    """
    –ü–∞—Ä—Å–∏—Ç PDF –∏–Ω–≤–æ–π—Å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON —Å —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏ –∏ —Ç–æ–≤–∞—Ä–∞–º–∏
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç OpenAI GPT-4o Vision –¥–ª—è –ø—Ä—è–º–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    """
    # –ü–∞—Ä—Å–∏–º –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ OpenAI Vision
    result = parse_pdf_with_openai_vision(pdf_path, 'task-items-advanced.txt')

    return result


def export_to_excel_advanced(data: dict, excel_file: str, pdf_filename: str):
    """
    –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç Excel —Å —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª
    if Path(excel_file).exists():
        import xlrd
        from xlutils.copy import copy as xl_copy

        try:
            rb = xlrd.open_workbook(excel_file, formatting_info=True)
            wb = xl_copy(rb)
            sheet = wb.get_sheet(0)
            start_row = rb.sheet_by_index(0).nrows
        except:
            wb = xlwt.Workbook(encoding='utf-8')
            sheet = wb.add_sheet('–¢–æ–≤–∞—Ä—ã')
            start_row = 0
    else:
        wb = xlwt.Workbook(encoding='utf-8')
        sheet = wb.add_sheet('–¢–æ–≤–∞—Ä—ã')
        start_row = 0

    # –°—Ç–∏–ª–∏
    header_style = xlwt.easyxf('font: bold 1; align: horiz center')
    normal_style = xlwt.easyxf()

    # –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å, –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
    if start_row == 0:
        headers = [
            '–ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫',
            '–∫–æ–¥ –Ñ–î–†–ü–û–£',
            '—Ç–µ–ª–µ—Ñ–æ–Ω',
            '–∞–¥—Ä–µ—Å–∞',
            '–¥–∞—Ç–∞ –Ω–∞–∫–ª–∞–¥–Ω–æ—ó',
            '–Ω–æ–º–µ—Ä –Ω–∞–∫–ª–∞–¥–Ω–æ—ó',
            '–£–ö–¢ –ó–ï–î',
            '–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞',
            '–æ–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (–Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞, –∞—Ä—Ç–∏–∫–ª—å)',
            '—Ü—ñ–Ω–∞ –∑–∞ —à—Ç –±–µ–∑ –ø–¥–≤',
            '–∫—ñ–ª-—Å—Ç—å —à—Ç—É–∫',
            '—Å—É–º–∞ –±–µ–∑ –ø–¥–≤',
            '—Ü—ñ–Ω–∞ –∑–∞ –æ–¥–∏–Ω–∏—Ü—é –∑ –ü–î–í',
            '—Å—É–º–∞ –∑ –ü–î–í'
        ]
        for col, header in enumerate(headers):
            sheet.write(0, col, header, header_style)
        start_row = 1

    # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
    header = data.get('header', {})
    postachalnyk = header.get('postachalnyk', '')
    kod_edrpu = header.get('kod_edrpu', '')
    telefon = header.get('telefon', '')
    adresa = header.get('adresa', '')
    data_nakladnoi = header.get('data_nakladnoi', '')
    nomer_nakladnoi = header.get('nomer_nakladnoi', '')

    # –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–≤–∞—Ä–∞—Ö
    items = data.get('items', [])

    for idx, item in enumerate(items):
        row = start_row + idx

        # –†–µ–∫–≤–∏–∑–∏—Ç—ã –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ (–ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞)
        sheet.write(row, 0, postachalnyk, normal_style)
        sheet.write(row, 1, kod_edrpu, normal_style)
        sheet.write(row, 2, telefon, normal_style)
        sheet.write(row, 3, adresa, normal_style)
        sheet.write(row, 4, data_nakladnoi, normal_style)
        sheet.write(row, 5, nomer_nakladnoi, normal_style)

        # –î–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞
        sheet.write(row, 6, item.get('ukt_zed', ''), normal_style)
        sheet.write(row, 7, item.get('naimenovanie_tovara', ''), normal_style)
        sheet.write(row, 8, item.get('oboznachennya_tovara', ''), normal_style)
        sheet.write(row, 9, item.get('tsina_za_sht_bez_pdv', ''), normal_style)
        sheet.write(row, 10, item.get('kilkist_shtuk', ''), normal_style)
        sheet.write(row, 11, item.get('suma_bez_pdv', ''), normal_style)
        sheet.write(row, 12, item.get('tsina_za_odynytsyu_z_pdv', ''), normal_style)
        sheet.write(row, 13, item.get('suma_z_pdv', ''), normal_style)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
    wb.save(excel_file)
    print(f"‚úì –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ {len(items)} —Ç–æ–≤–∞—Ä–æ–≤ –≤ {excel_file}")


def process_invoice(pdf_path: str, excel_file: str = "—Ç–∞–±–ª–∏—Ü—è –Ω–∞–∫–ª–∞–¥–Ω–∏—Ö.xls"):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–¥–∏–Ω –∏–Ω–≤–æ–π—Å: –ø–∞—Ä—Å–∏—Ç –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –≤ Excel
    """
    print(f"\n{'='*60}")
    print(f"–û–±—Ä–∞–±–æ—Ç–∫–∞: {pdf_path}")
    print(f"{'='*60}")

    # –ü–∞—Ä—Å–∏–º –∏–Ω–≤–æ–π—Å
    result = parse_invoice_complete(pdf_path)

    if 'error' in result:
        print(f"‚úó –û—à–∏–±–∫–∞: {result['error']}")
        return result

    # –í—ã–≤–æ–¥–∏–º –∫—Ä–∞—Ç–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    header = result.get('header', {})
    items_count = len(result.get('items', []))

    print(f"\nüìã –†–µ–∫–≤–∏–∑–∏—Ç—ã:")
    print(f"  –ü–æ—Å—Ç–∞–≤—â–∏–∫: {header.get('postachalnyk', 'N/A')}")
    print(f"  –Ñ–î–†–ü–û–£: {header.get('kod_edrpu', 'N/A')}")
    print(f"  –î–∞—Ç–∞: {header.get('data_nakladnoi', 'N/A')}")
    print(f"  –ù–æ–º–µ—Ä: {header.get('nomer_nakladnoi', 'N/A')}")
    print(f"\nüì¶ –¢–æ–≤–∞—Ä–æ–≤: {items_count}")

    # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ Excel
    pdf_filename = Path(pdf_path).name
    export_to_excel_advanced(result, excel_file, pdf_filename)

    return result


def process_multiple_invoices(pdf_paths: list, excel_file: str = "—Ç–∞–±–ª–∏—Ü—è –Ω–∞–∫–ª–∞–¥–Ω–∏—Ö.xls"):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω–≤–æ–π—Å–æ–≤
    """
    total_items = 0
    success_count = 0
    failed_count = 0

    for pdf_path in pdf_paths:
        try:
            result = process_invoice(pdf_path, excel_file)
            if 'error' not in result:
                total_items += len(result.get('items', []))
                success_count += 1
            else:
                failed_count += 1
        except Exception as e:
            print(f"‚úó –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ {pdf_path}: {e}\n")
            failed_count += 1

    print(f"\n{'='*60}")
    print(f"üìä –ò–¢–û–ì–ò")
    print(f"{'='*60}")
    print(f"‚úì –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {success_count} —Ñ–∞–π–ª–æ–≤")
    print(f"‚úó –û—à–∏–±–æ–∫: {failed_count}")
    print(f"üì¶ –í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤: {total_items}")
    print(f"üíæ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã: {excel_file}")
    print(f"{'='*60}\n")


def main():
    if len(sys.argv) < 2:
        print("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:")
        print("  python3 invoice_parser_vision.py <–ø—É—Ç—å_–∫_pdf> [output.xls]")
        print("  python3 invoice_parser_vision.py <–ø—É—Ç—å1.pdf> <–ø—É—Ç—å2.pdf> ... [output.xls]")
        print("  python3 invoice_parser_vision.py invoices/*.pdf")
        sys.exit(1)

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª Excel
    excel_file = "—Ç–∞–±–ª–∏—Ü—è –Ω–∞–∫–ª–∞–¥–Ω–∏—Ö.xls"
    pdf_paths = []

    for arg in sys.argv[1:]:
        if arg.endswith('.xls'):
            excel_file = arg
        else:
            pdf_paths.append(arg)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
    valid_paths = []
    for pdf_path in pdf_paths:
        if Path(pdf_path).exists():
            valid_paths.append(pdf_path)
        else:
            print(f"‚ö† –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {pdf_path}")

    if not valid_paths:
        print("‚úó –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –≤–∞–ª–∏–¥–Ω–æ–≥–æ PDF —Ñ–∞–π–ª–∞")
        sys.exit(1)

    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª—ã
    if len(valid_paths) == 1:
        process_invoice(valid_paths[0], excel_file)
    else:
        process_multiple_invoices(valid_paths, excel_file)


if __name__ == "__main__":
    main()
