<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug View</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #00ff00;
            font-size: 14px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #2d2d2d;
            border-left: 4px solid #00ff00;
        }
        .error { color: #ff4444; border-left-color: #ff4444; }
        .success { color: #00ff00; }
        .warning { color: #ffaa00; }
        pre {
            background: #000;
            padding: 10px;
            overflow-x: auto;
            color: #00ff00;
            white-space: pre-wrap;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-family: monospace;
            font-size: 16px;
            margin: 10px 5px;
        }
        #screenshot {
            background: white;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>üîç DEBUG VIEW - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞</h1>

    <button onclick="runFullTest()">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç</button>
    <button onclick="location.reload()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>

    <div id="output"></div>
    <div id="screenshot"></div>

    <script>
        const output = document.getElementById('output');
        const screenshot = document.getElementById('screenshot');

        function addLog(title, content, type = 'section') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `<strong>${title}</strong><pre>${content}</pre>`;
            output.appendChild(div);
        }

        async function runFullTest() {
            output.innerHTML = '';
            screenshot.innerHTML = '';

            addLog('üöÄ –ù–ê–ß–ê–õ–û –¢–ï–°–¢–ê', new Date().toLocaleTimeString());

            try {
                // –®–∞–≥ 1: –ü–∞—Ä—Å–∏–º –¥–æ–∫—É–º–µ–Ω—Ç
                addLog('üì§ –®–∞–≥ 1: –û—Ç–ø—Ä–∞–≤–∫–∞ lakover.jpg –Ω–∞ –ø–∞—Ä—Å–∏–Ω–≥', '–ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª...');

                const fileResp = await fetch('/invoices/lakover.jpg');
                if (!fileResp.ok) {
                    addLog('‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω', fileResp.status, 'error');
                    return;
                }

                const blob = await fileResp.blob();
                addLog('‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω', `–†–∞–∑–º–µ—Ä: ${blob.size} bytes`, 'success');

                const formData = new FormData();
                formData.append('file', blob, 'lakover.jpg');

                const parseResp = await fetch('/parse', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer mytoken'
                    },
                    body: formData
                });

                addLog('üì• –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞', `–°—Ç–∞—Ç—É—Å: ${parseResp.status}`);

                if (!parseResp.ok) {
                    const error = await parseResp.json();
                    addLog('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞', JSON.stringify(error, null, 2), 'error');
                    return;
                }

                const data = await parseResp.json();
                addLog('‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ —É—Å–ø–µ—à–µ–Ω', `success: ${data.success}`, 'success');

                // –®–∞–≥ 2: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
                addLog('üìä –®–∞–≥ 2: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö',
                    `–ö–ª—é—á–∏ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è:\n${Object.keys(data).join('\n')}`);

                if (!data.data) {
                    addLog('‚ùå –ü–†–û–ë–õ–ï–ú–ê', 'data.data –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç!', 'error');
                    return;
                }

                const parsedData = data.data;
                addLog('üìã –ö–ª—é—á–∏ –≤ data', Object.keys(parsedData).join(', '));

                // –®–∞–≥ 3: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é —Å–µ–∫—Ü–∏—é
                addLog('üìù –®–∞–≥ 3: –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–µ–∫—Ü–∏–π', '');

                if (parsedData.document_info) {
                    const fields = [];
                    for (const [key, value] of Object.entries(parsedData.document_info)) {
                        if (!key.endsWith('_label')) {
                            fields.push(`${key}: ${value}`);
                        }
                    }
                    addLog('‚úÖ document_info', fields.join('\n'), 'success');
                } else {
                    addLog('‚ùå document_info', '–û–¢–°–£–¢–°–¢–í–£–ï–¢', 'error');
                }

                if (parsedData.parties) {
                    if (parsedData.parties.supplier) {
                        const fields = [];
                        for (const [key, value] of Object.entries(parsedData.parties.supplier)) {
                            if (!key.endsWith('_label') && typeof value !== 'object') {
                                fields.push(`${key}: ${String(value).substring(0, 50)}`);
                            }
                        }
                        addLog('‚úÖ parties.supplier', fields.join('\n'), 'success');
                    }

                    const buyer = parsedData.parties.buyer || parsedData.parties.customer;
                    if (buyer) {
                        const fields = [];
                        for (const [key, value] of Object.entries(buyer)) {
                            if (!key.endsWith('_label') && typeof value !== 'object') {
                                fields.push(`${key}: ${String(value).substring(0, 50)}`);
                            }
                        }
                        addLog('‚úÖ parties.buyer/customer', fields.join('\n'), 'success');
                    }
                }

                if (parsedData.totals) {
                    const fields = [];
                    for (const [key, value] of Object.entries(parsedData.totals)) {
                        fields.push(`${key}: ${value}`);
                    }
                    addLog('‚úÖ totals', fields.join('\n'), 'success');
                }

                // –¢–æ–≤–∞—Ä—ã
                let items = parsedData.line_items || parsedData.items || [];
                let column_mapping = parsedData.column_mapping || {};

                if (parsedData.table_data) {
                    items = parsedData.table_data.line_items || parsedData.table_data.items || items;
                    column_mapping = parsedData.table_data.column_mapping || column_mapping;
                }

                addLog('üõí Items', `Count: ${items.length}${items.length > 0 ? '\nFields: ' + Object.keys(items[0]).join(', ') : ''}`, items.length > 0 ? 'success' : 'warning');

                if (Object.keys(column_mapping).length > 0) {
                    addLog('üìä column_mapping', JSON.stringify(column_mapping, null, 2), 'success');
                }

                // –®–∞–≥ 4: –≠–º—É–ª–∏—Ä—É–µ–º displayEditableData
                addLog('üé® –®–∞–≥ 4: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã—Ö –ø–æ–ª–µ–π', '');

                let html = '<div style="background: white; color: black; padding: 20px; font-family: Arial;">';
                html += '<h2>–ü—Ä–µ–≤—å—é —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã—Ö –ø–æ–ª–µ–π:</h2>';

                // document_info
                if (parsedData.document_info) {
                    html += '<h3>üìÑ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–∫—É–º–µ–Ω—Ç–µ</h3>';
                    for (const [key, value] of Object.entries(parsedData.document_info)) {
                        if (!key.endsWith('_label') && typeof value !== 'object') {
                            html += `<div style="margin: 10px 0;">`;
                            html += `<label style="display: block; font-weight: bold;">${key}:</label>`;
                            html += `<input type="text" value="${value || ''}" style="width: 100%; padding: 5px; font-size: 14px;">`;
                            html += `</div>`;
                        }
                    }
                }

                // parties.supplier
                if (parsedData.parties?.supplier) {
                    html += '<h3>üè¢ Supplier</h3>';
                    for (const [key, value] of Object.entries(parsedData.parties.supplier)) {
                        if (!key.endsWith('_label') && typeof value !== 'object') {
                            html += `<div style="margin: 10px 0;">`;
                            html += `<label style="display: block; font-weight: bold;">${key}:</label>`;
                            html += `<input type="text" value="${value || ''}" style="width: 100%; padding: 5px; font-size: 14px;">`;
                            html += `</div>`;
                        }
                    }
                }

                // –¢–æ–≤–∞—Ä—ã
                if (items.length > 0) {
                    html += '<h3>üõí Items</h3>';
                    html += '<table style="width: 100%; border-collapse: collapse;">';
                    html += '<thead><tr>';
                    for (const key of Object.keys(items[0])) {
                        if (!key.endsWith('_label') && key !== 'raw') {
                            const label = column_mapping[key] || key;
                            html += `<th style="border: 1px solid #ddd; padding: 8px; background: #f0f0f0;">${label}</th>`;
                        }
                    }
                    html += '</tr></thead><tbody>';
                    items.forEach((item, idx) => {
                        html += '<tr>';
                        for (const [key, value] of Object.entries(item)) {
                            if (!key.endsWith('_label') && key !== 'raw') {
                                html += `<td style="border: 1px solid #ddd; padding: 8px;"><input type="text" value="${value || ''}" style="width: 100%;"></td>`;
                            }
                        }
                        html += '</tr>';
                    });
                    html += '</tbody></table>';
                }

                html += '</div>';

                screenshot.innerHTML = html;
                addLog('‚úÖ HTML —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω', `–î–ª–∏–Ω–∞: ${html.length} —Å–∏–º–≤–æ–ª–æ–≤`, 'success');

                // –ò—Ç–æ–≥
                addLog('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', '');
                addLog('‚úÖ –¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù',
                    `–ï—Å–ª–∏ –≤—ã –≤–∏–¥–∏—Ç–µ –ø–æ–ª—è –≤—ã—à–µ —Å –¥–∞–Ω–Ω—ã–º–∏,\n–∑–Ω–∞—á–∏—Ç –ø—Ä–æ–±–ª–µ–º–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º script.js\n\n–°–º–æ—Ç—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –≤—ã—à–µ —Å –ø—Ä–µ–≤—å—é –ø–æ–ª–µ–π.`,
                    'success');

            } catch (error) {
                addLog('‚ùå –û–®–ò–ë–ö–ê', `${error.message}\n\n${error.stack}`, 'error');
            }
        }

        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫
        window.addEventListener('load', () => {
            setTimeout(runFullTest, 500);
        });
    </script>
</body>
</html>

