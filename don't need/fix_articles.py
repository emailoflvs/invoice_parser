#!/usr/bin/env python3
"""
–ü–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫–∞: –°–∫–ª–µ–∏–≤–∞–µ—Ç –∞—Ä—Ç–∏–∫—É–ª—ã, —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—ã–µ –Ω–∞ UKT –∏ Oboznachennya
"""

import xlrd
from xlutils.copy import copy as xl_copy
import sys

def fix_split_articles(input_file, output_file=None):
    """
    –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç –∞—Ä—Ç–∏–∫—É–ª—ã, –≥–¥–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –ø–æ–ø–∞–ª–∏ –≤ –∫–æ–ª–æ–Ω–∫—É –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è
    """
    if output_file is None:
        output_file = input_file

    # –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª
    rb = xlrd.open_workbook(input_file, formatting_info=True)
    wb = xl_copy(rb)
    sheet = wb.get_sheet(0)
    rs = rb.sheet_by_index(0)

    fixed_count = 0

    print(f"–û–±—Ä–∞–±–æ—Ç–∫–∞: {input_file}")
    print(f"–°—Ç—Ä–æ–∫: {rs.nrows}")

    # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —Å—Ç—Ä–æ–∫–∞–º (–∫—Ä–æ–º–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞)
    for row in range(1, rs.nrows):
        ukt = rs.cell_value(row, 6)  # –£–ö–¢ –ó–ï–î
        oboz = rs.cell_value(row, 8)  # –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞

        # –ï—Å–ª–∏ –∞—Ä—Ç–∏–∫—É–ª –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ .00 –∏ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ - —ç—Ç–æ —Ü–∏—Ñ—Ä–∞
        if isinstance(ukt, str) and isinstance(oboz, str):
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ —Ü–∏—Ñ—Ä–æ–π –∏–ª–∏ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∫ –∞—Ä—Ç–∏–∫—É–ª—É
            if oboz and len(oboz) <= 3 and oboz.replace('-', '').isdigit():
                # –≠—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –∞—Ä—Ç–∏–∫—É–ª–∞
                new_ukt = ukt + oboz
                sheet.write(row, 6, new_ukt)
                sheet.write(row, 8, '')  # –û—á–∏—â–∞–µ–º –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ

                print(f"  Row {row}: {ukt} + {oboz} ‚Üí {new_ukt}")
                fixed_count += 1

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º
    wb.save(output_file)
    print(f"\n‚úì –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ {fixed_count} –∞—Ä—Ç–∏–∫—É–ª–æ–≤")
    print(f"üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {output_file}")

    return fixed_count


def verify_results(file_path):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    """
    wb = xlrd.open_workbook(file_path)
    sheet = wb.sheet_by_index(0)

    print(f"\nüìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:")
    print(f"–ü–µ—Ä–≤—ã–µ 10 –∞—Ä—Ç–∏–∫—É–ª–æ–≤:")

    for i in range(1, min(11, sheet.nrows)):
        ukt = sheet.cell_value(i, 6)
        name = sheet.cell_value(i, 7)
        oboz = sheet.cell_value(i, 8)

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∞—Ä—Ç–∏–∫—É–ª—ã
        warning = ""
        if isinstance(ukt, str) and ukt.endswith('.00') and not oboz:
            warning = " ‚ö†Ô∏è"

        print(f"  {i}. {ukt}{warning}")
        if oboz:
            print(f"      –û–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ: {oboz}")


def main():
    if len(sys.argv) < 2:
        print("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:")
        print("  python3 fix_articles.py <input.xls> [output.xls]")
        sys.exit(1)

    input_file = sys.argv[1]
    output_file = sys.argv[2] if len(sys.argv) > 2 else input_file

    # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º
    fixed_count = fix_split_articles(input_file, output_file)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º
    if fixed_count > 0:
        verify_results(output_file)


if __name__ == "__main__":
    main()
