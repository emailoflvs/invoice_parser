# Объяснение исправлений хардкода

## 1. Динамические размеры колонок (100% автоматические)

**Исправление:**
Убраны ВСЕ статические размеры и хардкод. Ширина колонок рассчитывается браузером автоматически.

**Принцип работы:**
- **Все колонки**: `width: auto` - браузер автоматически рассчитывает ширину
- **Нет статических размеров**: нет `px`, нет фиксированных значений
- **Нет магических чисел**: все условия основаны на анализе содержимого
- **Адаптивно**: работает на любых устройствах (desktop, tablet, mobile)

**УНИВЕРСАЛЬНАЯ система для ЛЮБЫХ колонок:**

Система работает с ЛЮБЫМ количеством колонок с ЛЮБЫМ содержимым.
Нет предопределенных типов - только простые универсальные правила.

**Определение свойств колонки:**

1. **Приоритет 1: Конфигурация**
   - Если ключ колонки указан в конфиге → используем настройки из конфига
   - Поддерживаемые ключи: `lineNumber`, `product`, `price`, `quantity`, `code`

2. **Приоритет 2: Анализ содержимого (универсальные правила)**
   - **Очень короткие числовые** (1-3 символа, в основном цифры) → номер строки
     - Выравнивание: центр, без переноса

   - **Длинный текст** (большая средняя длина или много слов) → описательное поле
     - Выравнивание: слева, с переносом, textarea

   - **В основном числа** (высокий числовой коэффициент) → числовое поле
     - Выравнивание: справа, БЕЗ переноса

   - **Короткие повторяющиеся** (высокий коэффициент повторений) → единицы, статусы
     - Выравнивание: центр, без переноса

   - **Все остальное** → универсальный тип
     - Выравнивание: автоматически (числа → справа, короткий текст → центр, длинный → слева)
     - Перенос: если содержимое длинное
     - Textarea: если нужен перенос

3. **Ширина колонок (подсказки браузеру)**
   - **Узкие колонки** (номера, количество, единицы): `width: 1%`
     - Подсказка браузеру: "сожми до минимума"
     - В комбинации с `white-space: nowrap` → ровно по содержимому

   - **Широкие колонки** (описания, длинный текст): `width: auto`
     - Подсказка браузеру: "займи оставшееся место"
     - Приоритет расширения

   - **Средние колонки** (коды, цены): `width: 1%` или `auto`
     - Зависит от того, нужен ли перенос
     - Если без переноса → `1%` (по содержимому)
     - Если с переносом → `auto` (может расширяться)

   **Важно:** `1%` - это НЕ статический размер!
   - Это подсказка браузеру о приоритете распределения
   - Браузер сам рассчитывает точные пиксели
   - Адаптируется к содержимому и экрану

**Определение необходимости textarea:**
- Явно указано в типе колонки
- Колонка допускает перенос (`whiteSpace: 'normal'`)
- Содержимое содержит переносы строк

**Преимущества:**
- ПОЛНОСТЬЮ динамическая система - браузер управляет всем
- НЕТ хардкода - НИ ОДНОГО магического числа
- НЕТ статических размеров - адаптируется к любому экрану
- Работает на всех устройствах (desktop, tablet, mobile)
- Все решения основаны на анализе реального содержимого

## 2. Словарь транслитерации

**Расположение:** `src/invoiceparser/exporters/json_exporter.py`, функция `transliterate_to_latin()`

**Назначение:** Преобразует кириллические символы (русский/украинский) в латинские для использования в именах файлов

**Код:**
```python
translit_map = {
    'а': 'a', 'б': 'b', 'в': 'v', 'г': 'g', 'д': 'd', 'е': 'e', 'ё': 'yo',
    'ж': 'zh', 'з': 'z', 'и': 'i', 'й': 'y', 'к': 'k', 'л': 'l', 'м': 'm',
    'н': 'n', 'о': 'o', 'п': 'p', 'р': 'r', 'с': 's', 'т': 't', 'у': 'u',
    'ф': 'f', 'х': 'h', 'ц': 'ts', 'ч': 'ch', 'ш': 'sh', 'щ': 'sch',
    'ъ': '', 'ы': 'y', 'ь': '', 'э': 'e', 'ю': 'yu', 'я': 'ya',
    'А': 'A', 'Б': 'B', 'В': 'V', 'Г': 'G', 'Д': 'D', 'Е': 'E', 'Ё': 'Yo',
    'Ж': 'Zh', 'З': 'Z', 'И': 'I', 'Й': 'Y', 'К': 'K', 'Л': 'L', 'М': 'M',
    'Н': 'N', 'О': 'O', 'П': 'P', 'Р': 'R', 'С': 'S', 'Т': 'T', 'У': 'U',
    'Ф': 'F', 'Х': 'H', 'Ц': 'Ts', 'Ч': 'Ch', 'Ш': 'Sh', 'Щ': 'Sch',
    'Ъ': '', 'Ы': 'Y', 'Ь': '', 'Э': 'E', 'Ю': 'Yu', 'Я': 'Ya',
    'і': 'i', 'ї': 'yi', 'є': 'ye', 'ґ': 'g',  # Украинские символы
    'І': 'I', 'Ї': 'Yi', 'Є': 'Ye', 'Ґ': 'G'
}
```

**Использование:** При сохранении файлов с кириллическими именами, они транслитерируются в латиницу для совместимости с файловыми системами

**Является ли хардкодом:** Да, это хардкод маппинга символов. Но это необходимо для функциональности транслитерации. Можно вынести в конфигурационный файл, но это избыточно для такого статичного маппинга.

## 3. max_age cookie (7 дней)

**Что это:**
- `max_age=60 * 60 * 24 * 7` - время жизни cookie с токеном авторизации
- 60 секунд * 60 минут * 24 часа * 7 дней = 604800 секунд = 7 дней

**Исправление:**
- Вынесено в конфигурацию: `JWT_COOKIE_MAX_AGE_DAYS` (по умолчанию 7 дней)
- Теперь можно настроить через `.env` файл

## 4. Проверки названий колонок

**Проблема:** В `script.js` были проверки названий колонок на разных языках (русский, украинский, английский)

**Исправление:**
- Убраны все проверки по названиям (labels)
- Теперь проверка идет ТОЛЬКО по ключам (keys) из конфигурации
- Ключи для определения типов колонок настраиваются через `.env`:
  - `COLUMN_TYPE_LINE_NUMBER_KEYS` - ключи для номера строки
  - `COLUMN_TYPE_PRODUCT_KEYS` - ключи для описания товара
  - `COLUMN_TYPE_PRICE_KEYS` - ключи для цен/сумм
  - `COLUMN_TYPE_QUANTITY_KEYS` - ключи для количества
  - `COLUMN_TYPE_CODE_KEYS` - ключи для кодов товаров

**Преимущества:**
- Полная мультиязычность - не зависит от языка названий колонок
- Настраиваемость через конфигурацию
- Использует только ключи из данных после парсинга

## 5. Убран хардкод localhost/127.0.0.1

**Проблема:** В `telegram_bot.py` был хардкод `http://127.0.0.1:{web_port}`

**Исправление:**
- Убран fallback на localhost
- Теперь используется ТОЛЬКО `WEB_PUBLIC_URL` из конфигурации
- Если `WEB_PUBLIC_URL` не настроен, показывается только document_id без кнопки редактирования

## 6. Названия колонок Excel в .env

**Исправление:**
- Все названия листов и колонок Excel уже настраиваются через `.env`:
  - `EXCEL_SHEET_HEADER_NAME` - название листа реквизитов (по умолчанию "Реквизиты")
  - `EXCEL_SHEET_ITEMS_NAME` - название листа позиций (по умолчанию "Позиции")
  - `EXCEL_HEADER_FIELD_COLUMN` - название колонки "Поле"
  - `EXCEL_HEADER_VALUE_COLUMN` - название колонки "Значение"
  - `SHEETS_HEADER_SHEET` - название листа в Google Sheets для реквизитов
  - `SHEETS_ITEMS_SHEET` - название листа в Google Sheets для позиций

**Примечание:** Значения по умолчанию на русском языке, но их можно изменить в `.env`

## 7. Убран хардкод column_order из interface-rules.json

**Исправление:**
- Удален хардкоженный список приоритетных колонок
- Теперь порядок колонок определяется динамически из `column_mapping` в данных после парсинга
- Добавлено описание, что порядок определяется динамически

