# –ü–æ–ª–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

## üìö –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã](#–æ–±–∑–æ—Ä)
2. [–û—Ç–≤–µ—Ç—ã –Ω–∞ –∫–ª—é—á–µ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã](#–æ—Ç–≤–µ—Ç—ã-–Ω–∞-–≤–æ–ø—Ä–æ—Å—ã)
3. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-—Ç–∞–±–ª–∏—Ü)
4. [–ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö](#–ø–æ—Ç–æ–∫-–¥–∞–Ω–Ω—ã—Ö)
5. [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#–ø—Ä–∏–º–µ—Ä—ã-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
6. [–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ](#–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ)

---

## –û–±–∑–æ—Ä

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–∞ —Å –Ω—É–ª—è —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π:
- ‚úÖ **RAW (—Å—ã—Ä—ã–µ)** –¥–∞–Ω–Ω—ã–µ –æ—Ç AI
- ‚úÖ **APPROVED (—É—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ)** –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
- ‚úÖ **JSON —Å–Ω–∞–ø—à–æ—Ç—ã** –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –∏ –∞—É–¥–∏—Ç–∞
- ‚úÖ **–û–±—É—á–µ–Ω–∏–µ –Ω–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞—Ö** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
- ‚úÖ **–ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å** –∏ —Ä–∞–±–æ—Ç–∞ —Å –ª—é–±—ã–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏
- ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** –Ω–∞ –º–∏–ª–ª–∏–æ–Ω—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- ‚úÖ **–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø–æ–ª—è** - —á–µ—Ç–∫–∏–π –º–µ—Ö–∞–Ω–∏–∑–º –æ–±—Ä–∞–±–æ—Ç–∫–∏
- ‚úÖ **–ü–æ–¥–ø–∏—Å–∏/–ø–µ—á–∞—Ç–∏** - –æ—Ç 1 –¥–æ 20+ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç
- ‚úÖ **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–æ–ª–æ–Ω–∫–∏** - —á–µ—Ä–µ–∑ column_mapping –∏–∑ –ø—Ä–æ–º–ø—Ç–æ–≤

---

## –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã

### 1. ‚ùì –ö—É–¥–∞ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –ù–ï–ò–ó–í–ï–°–¢–ù–´–ï –ø–æ–ª—è?

**–ü—Ä–æ–±–ª–µ–º–∞:** AI –Ω–∞—Ö–æ–¥–∏—Ç –ø–æ–ª–µ, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ.

**‚úÖ –†–µ—à–µ–Ω–∏–µ:** –í —Ç–∞–±–ª–∏—Ü—É `document_fields` —Å `field_id = NULL`

```sql
-- –ò–ó–í–ï–°–¢–ù–û–ï –ø–æ–ª–µ (–µ—Å—Ç—å –≤ field_definitions):
INSERT INTO document_fields (
    document_id, field_id, field_code, raw_label, raw_value_text
) VALUES (
    123, 45, 'supplier_tax_id', '–Ü–ü–ù', '374835510226'
);

-- –ù–ï–ò–ó–í–ï–°–¢–ù–û–ï –ø–æ–ª–µ (–Ω–µ—Ç –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ):
INSERT INTO document_fields (
    document_id, field_id, field_code, raw_label, raw_value_text, section
) VALUES (
    123, NULL, NULL, '–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è', '–¢–µ—Ä–º—ñ–Ω–æ–≤–∞ –¥–æ—Å—Ç–∞–≤–∫–∞', 'other'
    --   ^^^^  ^^^^  -- NULL = –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –ø–æ–ª–µ!
);
```

**–ü–æ–∏—Å–∫ –≤—Å–µ—Ö –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø–æ–ª–µ–π:**
```sql
SELECT 
    raw_label,
    raw_value_text,
    COUNT(*) as occurrences
FROM document_fields
WHERE field_id IS NULL  -- –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ –ø–æ–ª—è
GROUP BY raw_label, raw_value_text
ORDER BY occurrences DESC;
```

**–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –∏–∑–≤–µ—Å—Ç–Ω—ã–º:**
```python
# 1. –î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫
new_field = FieldDefinition(
    code='special_instructions',
    section='other',
    data_type='text'
)

# 2. –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏
session.execute(
    update(DocumentField)
    .where(DocumentField.field_id == None)
    .where(DocumentField.raw_label == '–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è')
    .values(field_id=new_field.id, field_code='special_instructions')
)
```

---

### 2. ‚ùì –ö—É–¥–∞ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å 1-20 –ø–æ–¥–ø–∏—Å–µ–π/–ø–µ—á–∞—Ç–µ–π?

**–ü—Ä–æ–±–ª–µ–º–∞:** –í JSON –º–∞—Å—Å–∏–≤ signatures —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ–¥–ø–∏—Å–µ–π.

**‚úÖ –†–µ—à–µ–Ω–∏–µ:** –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ `document_signatures`

```sql
CREATE TABLE document_signatures (
    id                  BIGINT PRIMARY KEY,
    document_id         BIGINT FK -> documents,
    signature_index     INTEGER,              -- 0, 1, 2... (–ø–æ—Ä—è–¥–æ–∫)
    
    -- –î–∞–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∏
    role                TEXT,                 -- "–ë—É—Ö–≥–∞–ª—Ç–µ—Ä", "Director"
    name                TEXT,                 -- –§–ò–û
    is_signed           BOOLEAN,              -- –µ—Å—Ç—å –ø–æ–¥–ø–∏—Å—å?
    is_stamped          BOOLEAN,              -- –µ—Å—Ç—å –ø–µ—á–∞—Ç—å?
    stamp_content       TEXT,                 -- —Ç–µ–∫—Å—Ç —Å –ø–µ—á–∞—Ç–∏
    handwritten_date    TEXT,                 -- –¥–∞—Ç–∞ –æ—Ç —Ä—É–∫–∏
    
    -- RAW vs APPROVED (–∫–∞–∫ –≤ –ø–æ–ª—è—Ö!)
    raw_value           JSONB,
    approved_value      JSONB,
    is_corrected        BOOLEAN,
    
    -- –õ–æ–∫–∞—Ü–∏—è
    page_id             BIGINT FK,
    bbox                JSONB
);
```

**–ü—Ä–∏–º–µ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:**
```python
signatures_array = json_data.get('signatures', [])

for idx, sig_data in enumerate(signatures_array):
    signature = DocumentSignature(
        document_id=doc_id,
        signature_index=idx,
        role=sig_data.get('role'),
        name=sig_data.get('name'),
        is_signed=sig_data.get('is_signed', False),
        is_stamped=sig_data.get('is_stamped', False),
        stamp_content=sig_data.get('stamp_content'),
        raw_value=sig_data  # –≤–µ—Å—å JSON
    )
    session.add(signature)
```

---

### 3. ‚ùì –ó–∞—á–µ–º `documents` –æ—Ç–¥–µ–ª—å–Ω–æ, –µ—Å–ª–∏ –≤—Å–µ –≤ `document_fields`?

**–í–∞—à –≤–æ–ø—Ä–æ—Å –±—ã–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º!** üéØ

**–ü–†–û–ë–õ–ï–ú–ê –≤ –ø–µ—Ä–≤–æ–π –≤–µ—Ä—Å–∏–∏:**
```sql
-- –ë—ã–ª–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ:
documents:
    document_number     TEXT,     -- ‚ùå –¥—É–±–ª–∏—Ä—É–µ—Ç document_fields
    document_date       DATE,     -- ‚ùå –¥—É–±–ª–∏—Ä—É–µ—Ç document_fields
    total_with_vat      NUMERIC   -- ‚ùå –¥—É–±–ª–∏—Ä—É–µ—Ç document_fields
```

**‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û - documents –ú–ò–ù–ò–ú–ê–õ–¨–ù–ê–Ø:**
```sql
CREATE TABLE documents (
    id                  BIGINT PRIMARY KEY,
    file_id             BIGINT FK -> files,
    doc_type_id         INTEGER FK -> document_types,
    
    -- –°—Ç–∞—Ç—É—Å –∏ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è
    status              VARCHAR(50),        -- parsed, approved, etc.
    language            VARCHAR(10),        -- uk, ru, en, fr
    country             VARCHAR(10),        -- UA, RU, FR
    
    -- –¢–û–õ–¨–ö–û foreign keys (–¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏)
    supplier_id         BIGINT FK -> companies,
    buyer_id            BIGINT FK -> companies,
    
    -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    created_at          TIMESTAMP,
    created_by          BIGINT,
    updated_at          TIMESTAMP,
    parsing_metadata    JSONB
);

-- ‚ö†Ô∏è –ù–ï–¢ document_number, date, totals!
-- ‚ö†Ô∏è –í–°–ï –±–∏–∑–Ω–µ—Å-–¥–∞–Ω–Ω—ã–µ –¢–û–õ–¨–ö–û –≤ document_fields!
```

**–ó–∞—á–µ–º —Ç–æ–≥–¥–∞ documents?**
1. **–ë—ã—Å—Ç—Ä–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è:** `WHERE supplier_id = 123`
2. **Workflow:** `WHERE status = 'in_review'`
3. **–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:** `WHERE created_at > '2025-01-01'`

**–ü–æ–ª—É—á–µ–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–¥–∞–Ω–Ω—ã—Ö:**
```sql
-- –ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞:
SELECT approved_value_text 
FROM document_fields
WHERE document_id = 123 AND field_code = 'document_number';

-- –ù–ï –∏–∑ documents!
```

---

### 4. ‚ùì –ñ–µ—Å—Ç–∫–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ document_lines - –ø–ª–æ—Ö–æ –¥–ª—è –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç–∏

**–ü–†–û–ë–õ–ï–ú–ê –≤ –ø–µ—Ä–≤–æ–π –≤–µ—Ä—Å–∏–∏:**
```sql
-- –ñ–µ—Å—Ç–∫–∏–µ –∫–æ–ª–æ–Ω–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –£–∫—Ä–∞–∏–Ω—ã:
document_lines:
    product_code        TEXT,
    product_name        TEXT,
    ukt_zed             VARCHAR(20),  -- ‚ùå —Ç–æ–ª—å–∫–æ –¥–ª—è UA!
    quantity            NUMERIC,
    unit                VARCHAR(50),
    price_without_vat   NUMERIC       -- ‚ùå —Ç–æ–ª—å–∫–æ –¥–ª—è –ù–î–°!
```

**–ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è:**
- –§—Ä–∞–Ω—Ü–∏–∏: "Code Douane", "D√©signation", "Quantit√©"
- –†–æ—Å—Å–∏–∏: "–ê—Ä—Ç–∏–∫—É–ª", "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ", "–ö–æ–ª-–≤–æ"
- –°–®–ê: "SKU", "Description", "Qty"

**‚úÖ –†–ï–®–ï–ù–ò–ï: `document_table_sections` —Å JSONB**

```sql
CREATE TABLE document_table_sections (
    id                      BIGINT PRIMARY KEY,
    document_id             BIGINT FK -> documents,
    section_name            VARCHAR(100),  -- 'line_items', 'deliveries'
    
    -- Column mapping (—Ç–æ—á–Ω–æ –∫–∞–∫ –≤ –ø—Ä–æ–º–ø—Ç–∞—Ö!)
    column_mapping_raw      JSONB,
    column_mapping_approved JSONB,
    
    -- –°—Ç—Ä–æ–∫–∏ (–î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ï –∫–ª—é—á–∏!)
    rows_raw                JSONB,  -- –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤
    rows_approved           JSONB,
    
    is_corrected            BOOLEAN
);
```

**–£–∫—Ä–∞–∏–Ω—Å–∫–∏–π –¥–æ–∫—É–º–µ–Ω—Ç:**
```json
{
    "column_mapping_raw": {
        "no": "‚Ññ",
        "ukt_zed": "–£–ö–¢ –ó–ï–î",
        "tovar": "–¢–æ–≤–∞—Ä",
        "kilkist": "–ö—ñ–ª—å–∫—ñ—Å—Ç—å",
        "tsina_bez_pdv": "–¶—ñ–Ω–∞ –±–µ–∑ –ü–î–í"
    },
    "rows_raw": [
        {"no": 1, "ukt_zed": "8501510090", "tovar": "Motor", "kilkist": "2 —à—Ç", "tsina_bez_pdv": 4341.66}
    ]
}
```

**–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –¥–æ–∫—É–º–µ–Ω—Ç:**
```json
{
    "column_mapping_raw": {
        "no": "‚Ññ",
        "code_douane": "Code Douane",
        "designation": "D√©signation",
        "quantite": "Quantit√©",
        "prix_ht": "Prix HT"
    },
    "rows_raw": [
        {"no": 1, "code_douane": "8501510090", "designation": "Moteur", "quantite": "2 pcs", "prix_ht": 4341.66}
    ]
}
```

**–†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –õ–Æ–ë–û–ì–û —è–∑—ã–∫–∞!** ‚úÖ

---

### 5. ‚ùì –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å column_mapping –∏–∑ –ø—Ä–æ–º–ø—Ç–æ–≤

**–ò–∑ –ø—Ä–æ–º–ø—Ç–∞:**
```
1. "column_mapping": {normalized_key: "Original Header"}
2. "line_items": [array of objects with keys from column_mapping]
```

**‚úÖ –í –ë–î –¢–û–ß–ù–û –¢–ê–ö –ñ–ï:**

```python
# –ò–∑ JSON (–æ—Ç AI):
table_data = {
    "column_mapping": {"no": "‚Ññ", "tovar": "–¢–æ–≤–∞—Ä"},
    "line_items": [{"no": 1, "tovar": "Motor"}]
}

# –í –ë–î (–ø—Ä—è–º–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ):
DocumentTableSection(
    column_mapping_raw=table_data['column_mapping'],  # –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π!
    rows_raw=table_data['line_items']                 # –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π!
)
```

**–ù–∏–∫–∞–∫–æ–≥–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è! –û–¥–∏–Ω –≤ –æ–¥–∏–Ω –∏–∑ –ø—Ä–æ–º–ø—Ç–∞!** ‚úÖ

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü

### –ò–µ—Ä–∞—Ä—Ö–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ú–ò–ù–ò–ú–ê–õ–¨–ù–ê–Ø CORE (–±–µ–∑ –±–∏–∑–Ω–µ—Å-–¥–∞–Ω–Ω—ã—Ö)           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ documents                                       ‚îÇ
‚îÇ  - ID, status, supplier_id, buyer_id, metadata  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –í–°–ï –ë–ò–ó–ù–ï–°-–î–ê–ù–ù–´–ï                               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ document_fields                                 ‚îÇ
‚îÇ  - –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø–æ–ª—è (field_id NOT NULL)          ‚îÇ
‚îÇ  - –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø–æ–ª—è (field_id = NULL)          ‚îÇ
‚îÇ  - raw_value + approved_value                   ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ document_signatures                             ‚îÇ
‚îÇ  - 1-20+ –ø–æ–¥–ø–∏—Å–µ–π/–ø–µ—á–∞—Ç–µ–π                      ‚îÇ
‚îÇ  - raw_value + approved_value                   ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ document_table_sections                         ‚îÇ
‚îÇ  - column_mapping (JSONB)                       ‚îÇ
‚îÇ  - rows (JSONB array)                           ‚îÇ
‚îÇ  - –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ò–°–¢–û–†–ò–Ø –ò –ê–£–î–ò–¢                                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ document_snapshots                              ‚îÇ
‚îÇ  - type: 'raw', 'approved'                      ‚îÇ
‚îÇ  - version: 1, 2, 3...                          ‚îÇ
‚îÇ  - payload: –ø–æ–ª–Ω—ã–π JSON                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –û–ë–£–ß–ï–ù–ò–ï –ù–ê –ü–û–°–¢–ê–í–©–ò–ö–ê–•                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ companies + company_document_profiles           ‚îÇ
‚îÇ  - –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –∑–Ω–∞–Ω–∏–π                            ‚îÇ
‚îÇ  - –ê–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ —Ç–∞–±–ª–∏—Ü

#### 1. –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏

```sql
-- –¢–∏–ø—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
document_types:
  id, code, name, description

-- –°–ª–æ–≤–∞—Ä—å –ø–æ–ª–µ–π
field_definitions:
  id, code, section, data_type, description

-- –ü–µ—Ä–µ–≤–æ–¥—ã –ø–æ–ª–µ–π
field_labels:
  id, field_id, locale, label
```

#### 2. –ö–æ–º–ø–∞–Ω–∏–∏ (–¥–ª—è –æ–±—É—á–µ–Ω–∏—è)

```sql
-- –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤
companies:
  id, legal_name, short_name
  tax_id, vat_id, registration_code
  country, language
  address_legal, address_postal
  iban, bank_name
  phone, email
  external_id, external_system
  is_verified
  created_at, updated_at

-- –ü—Ä–æ—Ñ–∏–ª–∏ –æ–±—É—á–µ–Ω–∏—è
company_document_profiles:
  id, company_id, doc_type_id
  is_active
  expected_currency, expected_vat_mode
  settings (JSONB)
  created_at, updated_at
```

#### 3. –§–∞–π–ª—ã

```sql
-- –§–∏–∑–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
files:
  id, storage_path, original_filename
  file_hash, mime_type, size_bytes
  uploaded_at, uploaded_by

-- –°—Ç—Ä–∞–Ω–∏—Ü—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
document_pages:
  id, document_id, file_id
  page_number, ocr_text
  created_at
```

#### 4. –î–æ–∫—É–º–µ–Ω—Ç—ã (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è core —Ç–∞–±–ª–∏—Ü–∞)

```sql
documents:
  id, file_id, doc_type_id
  status, language, country
  supplier_id, buyer_id  -- —Ç–æ–ª—å–∫–æ FK!
  created_at, created_by
  updated_at, updated_by
  parsing_metadata (JSONB)
  
-- ‚ö†Ô∏è –ë–ï–ó –±–∏–∑–Ω–µ—Å-–¥–∞–Ω–Ω—ã—Ö!
```

#### 5. –°–Ω–∞–ø—à–æ—Ç—ã (–ø–æ–ª–Ω—ã–µ JSON)

```sql
document_snapshots:
  id, document_id
  snapshot_type, version
  payload (JSONB)
  created_at, created_by
  
-- UNIQUE(document_id, snapshot_type, version)
```

#### 6. –ü–æ–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–¥–µ—Å—å!)

```sql
document_fields:
  id, document_id
  field_id, field_code  -- NULL –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö!
  section, group_key
  raw_label, language
  
  -- RAW –∑–Ω–∞—á–µ–Ω–∏—è (–æ—Ç AI)
  raw_value_text, raw_value_number
  raw_value_date, raw_value_bool
  raw_confidence
  
  -- APPROVED –∑–Ω–∞—á–µ–Ω–∏—è (–æ—Ç —á–µ–ª–æ–≤–µ–∫–∞)
  approved_value_text, approved_value_number
  approved_value_date, approved_value_bool
  approved_by, approved_at
  
  -- –ö–æ–Ω—Ç—Ä–æ–ª—å
  is_corrected, is_ignored
  
  -- –°–≤—è–∑–∏
  raw_snapshot_id, approved_snapshot_id
  page_id, bbox (JSONB)
  
  created_at, updated_at
```

#### 7. –ü–æ–¥–ø–∏—Å–∏ –∏ –ø–µ—á–∞—Ç–∏

```sql
document_signatures:
  id, document_id, signature_index
  role, name
  is_signed, is_stamped
  stamp_content, handwritten_date
  raw_value (JSONB), approved_value (JSONB)
  is_corrected
  page_id, bbox (JSONB)
  created_at, updated_at
```

#### 8. –¢–∞–±–ª–∏—Ü—ã —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ –∫–æ–ª–æ–Ω–∫–∞–º–∏

```sql
document_table_sections:
  id, document_id
  section_name, section_order
  column_mapping_raw (JSONB)
  column_mapping_approved (JSONB)
  rows_raw (JSONB)
  rows_approved (JSONB)
  is_corrected
  approved_by, approved_at
  created_at, updated_at
```

---

## –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

### –®–∞–≥ 1: –ü–∞—Ä—Å–∏–Ω–≥ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (AI ‚Üí RAW –¥–∞–Ω–Ω—ã–µ)

```python
# Gemini –≤–µ—Ä–Ω—É–ª JSON
raw_json = {
    "document_info": {"document_number": "755", ...},
    "parties": {"supplier": {...}, "customer": {...}},
    "totals": {...},
    "signatures": [{...}, {...}],
    "table_data": {
        "column_mapping": {...},
        "line_items": [...]
    }
}

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
async with db.session() as session:
    document = await db.save_parsed_document(
        session, file_path, raw_json
    )
```

**–ß—Ç–æ —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –ë–î:**

```
1. File ‚Üí –∑–∞–ø–∏—Å—å –æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–º —Ñ–∞–π–ª–µ
2. Document ‚Üí status='parsed', supplier_id, buyer_id
3. DocumentSnapshot ‚Üí type='raw', payload=raw_json
4. Companies ‚Üí –ø–æ—Å—Ç–∞–≤—â–∏–∫ –∏ –ø–æ–∫—É–ø–∞—Ç–µ–ª—å (–µ—Å–ª–∏ –Ω–æ–≤—ã–µ)
5. DocumentField √ó N ‚Üí –≤—Å–µ –ø–æ–ª—è, —Ç–æ–ª—å–∫–æ raw_*
6. DocumentSignature √ó N ‚Üí –≤—Å–µ –ø–æ–¥–ø–∏—Å–∏, —Ç–æ–ª—å–∫–æ raw_value
7. DocumentTableSection ‚Üí column_mapping_raw, rows_raw
```

---

### –®–∞–≥ 2: –ú–æ–¥–µ—Ä–∞—Ü–∏—è (—á–µ–ª–æ–≤–µ–∫ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç)

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ñ–æ—Ä–º—É —Å–æ –≤—Å–µ–º–∏ –ø–æ–ª—è–º–∏ –∏ –º–æ–∂–µ—Ç –ø—Ä–∞–≤–∏—Ç—å:

```
–ù–æ–º–µ—Ä:     [755] ‚úì
–î–∞—Ç–∞:      [2025-03-25] ‚úì
–ò–ù–ù:       [3748355–±] ‚úó ‚Üí –∏—Å–ø—Ä–∞–≤–∏–ª –Ω–∞ [37483556]
–°—É–º–º–∞:     [21919.97] ‚úì

–ü–æ–¥–ø–∏—Å—å 1: –ë—É—Ö–≥–∞–ª—Ç–µ—Ä - –ì–∞–ª–∏–Ω–∞ ‚úì
–ü–æ–¥–ø–∏—Å—å 2: –û—Ç—Ä–∏–º–∞–≤(–ª–∞) - –ü–∞–≤–ª–æ ‚úì

–¢–∞–±–ª–∏—Ü–∞:
  Row 1: Motor-reductor ... ‚úì
  Row 2: Motor-reductor ... ‚úì
```

---

### –®–∞–≥ 3: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ (APPROVED –¥–∞–Ω–Ω—ã–µ)

```python
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
saved_json = {
    # ... –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ...
}

async with db.session() as session:
    document = await db.save_approved_document(
        session, document_id, saved_json, user_id
    )
```

**–ß—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ –ë–î:**

```
1. Document ‚Üí status='approved', updated_by=user_id
2. DocumentSnapshot ‚Üí +1 –∑–∞–ø–∏—Å—å: type='approved', payload=saved_json
3. DocumentField ‚Üí approved_value_*, is_corrected=True (–≥–¥–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å)
4. DocumentSignature ‚Üí approved_value, is_corrected (–µ—Å–ª–∏ –ø—Ä–∞–≤–∏–ª–∏)
5. DocumentTableSection ‚Üí rows_approved (–µ—Å–ª–∏ –ø—Ä–∞–≤–∏–ª–∏ —Ç–∞–±–ª–∏—Ü—É)
```

**–¢–µ–ø–µ—Ä—å –≤ –ë–î:**
- RAW –¥–∞–Ω–Ω—ã–µ (–∫–∞–∫ AI —Ä–∞—Å–ø–∞—Ä—Å–∏–ª)
- APPROVED –¥–∞–Ω–Ω—ã–µ (–∫–∞–∫ —á–µ–ª–æ–≤–µ–∫ —É—Ç–≤–µ—Ä–¥–∏–ª)
- –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π (is_corrected=True)

---

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–º–∏ –ø–æ–ª—è–º–∏

```python
async def save_document_with_unknown_fields():
    """–ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø–æ–ª–µ–π"""
    
    # –ü–∞—Ä—Å–∏–Ω–≥ –≤–µ—Ä–Ω—É–ª —Ä–∞–∑–Ω—ã–µ –ø–æ–ª—è
    parsed_fields = [
        {"label": "–Ü–ü–ù", "value": "374835510226"},           # –∏–∑–≤–µ—Å—Ç–Ω–æ–µ
        {"label": "–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è", "value": "..."},   # –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ!
        {"label": "Special notes", "value": "..."}           # –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ!
    ]
    
    for field_data in parsed_fields:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫
        field_def = await find_field_definition(field_data['label'])
        
        if field_def:
            # –ò–∑–≤–µ—Å—Ç–Ω–æ–µ –ø–æ–ª–µ
            field = DocumentField(
                document_id=doc_id,
                field_id=field_def.id,
                field_code=field_def.code,
                raw_label=field_data['label'],
                raw_value_text=field_data['value']
            )
        else:
            # ‚ö†Ô∏è –ù–ï–ò–ó–í–ï–°–¢–ù–û–ï –ø–æ–ª–µ
            field = DocumentField(
                document_id=doc_id,
                field_id=None,              # NULL!
                field_code=None,            # NULL!
                section='other',
                raw_label=field_data['label'],  # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
                raw_value_text=field_data['value']
            )
        
        session.add(field)
```

### –ü—Ä–∏–º–µ—Ä 2: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–µ–π

```python
async def save_signatures():
    """–ü—Ä–∏–º–µ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è 1-20 –ø–æ–¥–ø–∏—Å–µ–π"""
    
    signatures = json_data.get('signatures', [])
    
    for idx, sig in enumerate(signatures):
        signature = DocumentSignature(
            document_id=doc_id,
            signature_index=idx,
            role=sig.get('role'),
            name=sig.get('name'),
            is_signed=sig.get('is_signed', False),
            is_stamped=sig.get('is_stamped', False),
            stamp_content=sig.get('stamp_content'),
            handwritten_date=sig.get('handwritten_date'),
            raw_value=sig  # –≤–µ—Å—å JSON –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
        )
        session.add(signature)
```

### –ü—Ä–∏–º–µ—Ä 3: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã (column_mapping)

```python
async def save_table_section():
    """–ü—Ä–∏–º–µ—Ä –ø—Ä—è–º–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑ –ø—Ä–æ–º–ø—Ç–∞"""
    
    table_data = json_data.get('table_data', {})
    
    # –ü—Ä—è–º–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–µ–∑ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è!
    table_section = DocumentTableSection(
        document_id=doc_id,
        section_name='line_items',
        column_mapping_raw=table_data.get('column_mapping', {}),
        rows_raw=table_data.get('line_items', [])
    )
    session.add(table_section)
```

### –ü—Ä–∏–º–µ—Ä 4: –ó–∞–ø—Ä–æ—Å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø–æ–ª–µ–π

```sql
-- –ù–∞–π—Ç–∏ –≤—Å–µ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø–æ–ª—è –∏ –∏—Ö —á–∞—Å—Ç–æ—Ç—É
SELECT 
    raw_label,
    COUNT(*) as occurrences,
    COUNT(DISTINCT document_id) as documents_count,
    MAX(raw_value_text) as example_value
FROM document_fields
WHERE field_id IS NULL
GROUP BY raw_label
ORDER BY occurrences DESC;

-- –†–µ–∑—É–ª—å—Ç–∞—Ç:
-- "–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è" | 15 | 12 | "–¢–µ—Ä–º—ñ–Ω–æ–≤–∞ –¥–æ—Å—Ç–∞–≤–∫–∞"
-- "Special instructions"  | 8  | 7  | "Rush order"
```

### –ü—Ä–∏–º–µ—Ä 5: –ó–∞–ø—Ä–æ—Å –ø–æ–¥–ø–∏—Å–µ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞

```python
async def get_document_signatures(doc_id):
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø–æ–¥–ø–∏—Å–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞"""
    
    result = await session.execute(
        select(DocumentSignature)
        .where(DocumentSignature.document_id == doc_id)
        .order_by(DocumentSignature.signature_index)
    )
    signatures = result.scalars().all()
    
    for sig in signatures:
        print(f"–ü–æ–¥–ø–∏—Å—å #{sig.signature_index}")
        print(f"  –†–æ–ª—å: {sig.role}")
        print(f"  –ò–º—è: {sig.name}")
        print(f"  –ü–æ–¥–ø–∏—Å–∞–Ω–æ: {sig.is_signed}")
        print(f"  –ü–µ—á–∞—Ç—å: {sig.is_stamped}")
```

### –ü—Ä–∏–º–µ—Ä 6: –†–∞–±–æ—Ç–∞ —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏

```python
async def get_table_data(doc_id):
    """–ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ –∫–æ–ª–æ–Ω–∫–∞–º–∏"""
    
    result = await session.execute(
        select(DocumentTableSection)
        .where(
            DocumentTableSection.document_id == doc_id,
            DocumentTableSection.section_name == 'line_items'
        )
    )
    table = result.scalar_one()
    
    # –ü–æ–ª—É—á–∞–µ–º column_mapping
    columns = table.column_mapping_approved or table.column_mapping_raw
    print(f"–ö–æ–ª–æ–Ω–∫–∏: {columns}")
    # {"no": "‚Ññ", "tovar": "–¢–æ–≤–∞—Ä", "kilkist": "–ö—ñ–ª—å–∫—ñ—Å—Ç—å"}
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä–æ–∫–∏
    rows = table.rows_approved or table.rows_raw
    for row in rows:
        print(f"Row {row.get('no')}: {row.get('tovar')}")
```

### –ü—Ä–∏–º–µ—Ä 7: –ü–æ–∏—Å–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –¥–ª—è –æ–±—É—á–µ–Ω–∏—è

```sql
-- –ö–∞–∫–∏–µ –ø–æ–ª—è —á–∞—â–µ –≤—Å–µ–≥–æ –∏—Å–ø—Ä–∞–≤–ª—è—é—Ç –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
SELECT 
    c.legal_name,
    df.field_code,
    COUNT(*) as correction_count,
    AVG(df.raw_confidence) as avg_ai_confidence
FROM document_fields df
JOIN documents d ON d.id = df.document_id
JOIN companies c ON c.id = d.supplier_id
WHERE df.is_corrected = TRUE
  AND c.id = 123
GROUP BY c.legal_name, df.field_code
ORDER BY correction_count DESC;

-- –†–µ–∑—É–ª—å—Ç–∞—Ç: –≥–¥–µ AI —á–∞—â–µ –≤—Å–µ–≥–æ –æ—à–∏–±–∞–µ—Ç—Å—è
-- "–¢–û–í –¢–ï–•–ù–û" | "supplier_iban" | 15 | 0.82
-- "–¢–û–í –¢–ï–•–ù–û" | "supplier_address" | 8 | 0.75
```

---

## –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

### –î–ª—è –º–∏–ª–ª–∏–æ–Ω–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

#### 1. –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

```sql
-- –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞—Ç—å documents –ø–æ created_at
CREATE TABLE documents_2025_q1 PARTITION OF documents
FOR VALUES FROM ('2025-01-01') TO ('2025-04-01');

CREATE TABLE documents_2025_q2 PARTITION OF documents
FOR VALUES FROM ('2025-04-01') TO ('2025-07-01');

-- –ö–∞—Å–∫–∞–¥–Ω–æ–µ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
-- document_fields –Ω–∞—Å–ª–µ–¥—É–µ—Ç –ø–∞—Ä—Ç–∏—Ü–∏—é —á–µ—Ä–µ–∑ document_id
```

#### 2. –ò–Ω–¥–µ–∫—Å—ã (—É–∂–µ –≤ –º–∏–≥—Ä–∞—Ü–∏–∏)

```sql
-- –û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
CREATE INDEX ix_documents_status ON documents(status);
CREATE INDEX ix_documents_supplier ON documents(supplier_id);
CREATE INDEX ix_documents_created ON documents(created_at);

-- –î–ª—è document_fields
CREATE INDEX ix_document_fields_doc_section 
    ON document_fields(document_id, section);
CREATE INDEX ix_document_fields_code 
    ON document_fields(field_code);
CREATE INDEX ix_document_fields_corrected 
    ON document_fields(is_corrected);  -- –¥–ª—è –æ–±—É—á–µ–Ω–∏—è!
CREATE INDEX ix_document_fields_unknown 
    ON document_fields(field_id);  -- NULL values –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö
```

#### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

```sql
-- –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ supplier_id (–±–µ–∑ JOIN)
SELECT * FROM documents 
WHERE supplier_id = 123 
  AND status = 'approved'
  AND created_at > '2025-01-01';

-- –î–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Å JOIN –∫ –ø–æ–ª—è–º)
SELECT d.*, df.*
FROM documents d
JOIN document_fields df ON df.document_id = d.id
WHERE d.id = 123;
```

#### 4. JSONB –∏–Ω–¥–µ–∫—Å—ã (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

```sql
-- –î–ª—è –ø–æ–∏—Å–∫–∞ –≤ column_mapping
CREATE INDEX idx_table_column_mapping 
    ON document_table_sections USING gin(column_mapping_raw);

-- –î–ª—è –ø–æ–∏—Å–∫–∞ –≤ rows
CREATE INDEX idx_table_rows 
    ON document_table_sections USING gin(rows_raw);

-- –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
SELECT * FROM document_table_sections
WHERE rows_raw @> '[{"tovar": "Motor"}]'::jsonb;
```

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º

### –í orchestrator.py

```python
from db_service import DatabaseService

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
db = DatabaseService(config.database_url)

# –ü–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ Gemini
gemini_result = await gemini_client.parse(file_path)

# –°–æ—Ö—Ä–∞–Ω—è–µ–º RAW –¥–∞–Ω–Ω—ã–µ
async with await db.get_session() as session:
    document = await db.save_parsed_document(
        session=session,
        file_path=file_path,
        raw_json=gemini_result,
        doc_type_code="UA_INVOICE"
    )
    logger.info(f"‚úÖ Saved RAW: document_id={document.id}")

# –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Ç–≤–µ—Ä–¥–∏–ª
if user_approved:
    async with await db.get_session() as session:
        await db.save_approved_document(
            session=session,
            document_id=document.id,
            approved_json=saved_json,
            user_id=current_user.id
        )
        logger.info(f"‚úÖ Saved APPROVED: document_id={document.id}")
```

---

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### ‚úÖ –†–µ—à–∞–µ—Ç –í–°–ï –∑–∞–¥–∞—á–∏

1. **‚úÖ –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø–æ–ª—è** ‚Üí field_id=NULL –≤ document_fields
2. **‚úÖ –ü–æ–¥–ø–∏—Å–∏ (1-20+)** ‚Üí document_signatures
3. **‚úÖ –ë–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è** ‚Üí documents –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è
4. **‚úÖ –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å** ‚Üí JSONB column_mapping
5. **‚úÖ –ü—Ä–æ–º–ø—Ç—ã** ‚Üí –ø—Ä—è–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ column_mapping
6. **‚úÖ RAW vs APPROVED** ‚Üí –≤ –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü–µ
7. **‚úÖ –ò—Å—Ç–æ—Ä–∏—è** ‚Üí document_snapshots
8. **‚úÖ –û–±—É—á–µ–Ω–∏–µ** ‚Üí companies + is_corrected —Ñ–ª–∞–≥

### ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

- –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –¥–∞—Ç–µ
- –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
- JSONB –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏
- –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è JOIN'–æ–≤

### ‚úÖ –ì–∏–±–∫–æ—Å—Ç—å

- –õ—é–±–æ–π —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞
- –õ—é–±–æ–π —è–∑—ã–∫
- –õ—é–±–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü
- –õ—é–±–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–ø–∏—Å–µ–π

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é**
   ```bash
   alembic upgrade head
   ```

2. **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ orchestrator**
   - –í—ã–∑–≤–∞—Ç—å `save_parsed_document` –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞
   - –í—ã–∑–≤–∞—Ç—å `save_approved_document` –ø–æ—Å–ª–µ –º–æ–¥–µ—Ä–∞—Ü–∏–∏

3. **UI –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏**
   - –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å RAW vs APPROVED
   - –ü–æ–¥—Å–≤–µ—Ç–∫–∞ is_corrected=True
   - –†–∞–±–æ—Ç–∞ —Å –ø–æ–¥–ø–∏—Å—è–º–∏ –∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏

4. **–°–∏—Å—Ç–µ–º–∞ –æ–±—É—á–µ–Ω–∏—è**
   - –ê–Ω–∞–ª–∏–∑ is_corrected –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
   - –ê–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–∑ company_document_profiles
   - Dashboard –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∏ —Ä–µ—à–∞–µ—Ç –í–°–ï –ø–æ–¥–Ω—è—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã:

‚úÖ –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø–æ–ª—è  
‚úÖ –ü–æ–¥–ø–∏—Å–∏/–ø–µ—á–∞—Ç–∏  
‚úÖ –ë–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è  
‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫–æ–ª–æ–Ω–∫–∏  
‚úÖ Column_mapping –∏–∑ –ø—Ä–æ–º–ø—Ç–æ–≤  
‚úÖ –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å  
‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å  
‚úÖ –û–±—É—á–µ–Ω–∏–µ –Ω–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞—Ö  

**–ì–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É!** üöÄ
