# Функционал редактируемых полей

## Что было реализовано

После парсинга документа, данные из JSON теперь отображаются в редактируемых полях на странице результатов.

### Основные изменения:

#### 1. Backend (FastAPI) - `/src/invoiceparser/adapters/web_api.py`
- ✅ Добавлен новый endpoint `POST /save` для сохранения отредактированных данных
- ✅ Добавлены модели `SaveRequest` и `SaveResponse`
- ✅ Данные сохраняются в JSON файл с суффиксом `_saved_<timestamp>.json` в директории `output/`

#### 2. Frontend - HTML/CSS/JavaScript

**HTML (`static/index.html`):**
- ✅ Добавлена секция "Редактирование данных" с редактируемыми полями
- ✅ Добавлена кнопка "Сохранить и продолжить"

**CSS (`static/style.css`):**
- ✅ Стили для редактируемых полей (`.editable-field`, `.editable-input`, `.editable-textarea`)
- ✅ Стили для группировки полей (`.editable-group`)
- ✅ Стили для таблицы редактирования товаров (`.editable-items-table`)
- ✅ Адаптивный дизайн для мобильных устройств

**JavaScript (`static/script.js`):**
- ✅ Функция `displayEditableData()` - создает редактируемую форму на основе JSON структуры
- ✅ Функция `collectEditedData()` - собирает отредактированные данные из формы
- ✅ Функция `saveAndContinue()` - отправляет данные на сервер и сохраняет в файл
- ✅ Поддержка меток из полей `_label` в JSON (например, `"document_type_label": "Тип документа:"`)
- ✅ Автоматическое определение типов полей (текст, textarea, select для boolean)
- ✅ Сохранение типов данных (числа остаются числами, строки - строками)

### Структура редактируемых данных:

#### Поддерживаемые секции JSON:
1. **document_info** - Информация о документе (номер, дата, валюта и т.д.)
2. **parties.supplier** - Данные поставщика
3. **parties.buyer** - Данные покупателя
4. **references** - Ссылки (номер контракта, основание и т.д.)
5. **totals** - Итоговые суммы
6. **line_items / items** - Товары и услуги (отображаются в виде таблицы)
7. Дополнительные поля верхнего уровня

### Метки полей

Система автоматически определяет метки для полей:
1. **Приоритет 1:** Использует поле `<fieldname>_label` из JSON (например, `"document_type_label": "Тип документа:"`)
2. **Приоритет 2:** Использует предопределенные русские метки из `fieldLabels` в JavaScript
3. **Приоритет 3:** Использует имя поля как есть

### Как использовать:

1. Загрузите документ через веб-интерфейс
2. После успешного парсинга откроется страница с результатами
3. В секции "Редактирование данных" отобразятся все поля в редактируемом виде
4. Внесите необходимые изменения
5. Нажмите кнопку **"Сохранить и продолжить"**
6. Данные будут сохранены в файл `<original_filename>_saved_<timestamp>.json` в директории `output/`
7. Система предложит загрузить новый документ

### Пример сохраненного файла:

Если загружен файл `invoice.pdf`, после сохранения будет создан файл:
```
output/invoice_saved_07120130.json
```

Где `07120130` - это timestamp в формате `DDMMHHmm` (07 декабря, 01:30)

## Технические детали:

### API Endpoint `/save`:
```
POST /save
Headers:
  Authorization: Bearer <token>
Body:
  {
    "original_filename": "invoice.pdf",
    "data": { /* отредактированные данные */ }
  }
Response:
  {
    "success": true,
    "filename": "invoice_saved_07120130.json",
    "message": "Данные успешно сохранены в файл invoice_saved_07120130.json"
  }
```

### Безопасность:
- Все данные экранируются через функцию `escapeHtml()` для предотвращения XSS атак
- Требуется авторизация через токен для сохранения данных
- Данные сохраняются только в указанную директорию `output/`

## Запуск сервера:

```bash
cd /home/lvs/Desktop/AI/servers/invoice_parser
source venv/bin/activate
LOGS_DIR=./logs TEMP_DIR=./temp OUTPUT_DIR=./output WEB_PORT=8001 python -m src.invoiceparser.app.main_web
```

Или используйте скрипт:
```bash
bash run_web.sh
```

## Доступ к приложению:

- Локально: http://localhost:8001
- Из сети (если разрешено): http://<your-ip>:8001

---

**Дата создания:** 07.12.2025
**Версия:** 1.0
**Статус:** ✅ Готово к использованию

